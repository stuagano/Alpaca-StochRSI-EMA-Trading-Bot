<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Candlestick Chart Test</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .chart-wrapper { 
            height: 400px; 
            margin: 20px 0; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        .status { 
            background: #e8f5e8; 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0; 
        }
        .controls { 
            margin: 20px 0; 
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-right: 10px; 
        }
        button:hover { 
            background: #0056b3; 
        }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 4px; 
            padding: 10px; 
            height: 200px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìà Real-time Candlestick Chart Test</h1>
        <div class="status">
            <strong>Status:</strong> <span id="status">Initializing...</span>
        </div>
        
        <div class="controls">
            <button onclick="testLatestBar()">Test Latest Bar API</button>
            <button onclick="testRealtimeBars()">Test Realtime Bars API</button>
            <button onclick="startSimulation()">Start Real-time Simulation</button>
            <button onclick="stopSimulation()">Stop Simulation</button>
        </div>
        
        <div class="chart-wrapper" id="chartContainer"></div>
        
        <h3>üìä API Test Log</h3>
        <div class="log" id="logContainer"></div>
    </div>

    <script>
        let chart = null;
        let candlestickSeries = null;
        let simulationInterval = null;
        const TEST_SYMBOL = 'AAPL'; // Use a common stock symbol for testing
        
        // Initialize chart
        function initChart() {
            const container = document.getElementById('chartContainer');
            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: 400,
                layout: {
                    backgroundColor: '#ffffff',
                    textColor: 'rgba(33, 56, 77, 1)',
                },
                grid: {
                    vertLines: { color: 'rgba(197, 203, 206, 0.5)' },
                    horzLines: { color: 'rgba(197, 203, 206, 0.5)' },
                },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                timeScale: { timeVisible: true, secondsVisible: false },
            });

            candlestickSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
            });

            updateStatus('Chart initialized successfully');
            log('‚úÖ Chart initialized with LightweightCharts');
        }
        
        // Logging utility
        function log(message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Status update utility
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            log(`üìä Status: ${message}`);
        }
        
        // Test latest bar API
        async function testLatestBar() {
            try {
                updateStatus(`Testing latest bar API for ${TEST_SYMBOL}...`);
                const response = await fetch(`/api/latest_bar/${TEST_SYMBOL}`);
                const data = await response.json();
                
                if (data.success) {
                    log(`‚úÖ Latest bar received: ${JSON.stringify(data.bar)}`);
                    log(`üïê Is new candle: ${data.is_new_candle}`);
                    log(`‚è∞ Is current minute: ${data.is_current_minute}`);
                    log(`üìÖ Bar age: ${Math.round(data.bar_age_seconds)}s`);
                    
                    // Add the bar to chart
                    if (candlestickSeries && data.bar) {
                        candlestickSeries.update(data.bar);
                        updateStatus('Latest bar added to chart');
                    }
                } else {
                    log(`‚ùå API Error: ${data.error}`);
                    updateStatus(`API Error: ${data.error}`);
                }
            } catch (error) {
                log(`üîå Network Error: ${error.message}`);
                updateStatus(`Network Error: ${error.message}`);
            }
        }
        
        // Test realtime bars API
        async function testRealtimeBars() {
            try {
                updateStatus(`Testing realtime bars API for ${TEST_SYMBOL}...`);
                const response = await fetch(`/api/realtime_bars/${TEST_SYMBOL}`);
                const data = await response.json();
                
                if (data.success) {
                    log(`‚úÖ Realtime bars received: ${data.bars_count} bars`);
                    log(`üìä Latest bar: ${JSON.stringify(data.latest_bar)}`);
                    log(`‚è∞ Current minute timestamp: ${data.current_minute_timestamp}`);
                    
                    // Update chart with all bars
                    if (candlestickSeries && data.bars && data.bars.length > 0) {
                        candlestickSeries.setData(data.bars);
                        updateStatus(`Chart updated with ${data.bars_count} bars`);
                    }
                } else {
                    log(`‚ùå API Error: ${data.error}`);
                    updateStatus(`API Error: ${data.error}`);
                }
            } catch (error) {
                log(`üîå Network Error: ${error.message}`);
                updateStatus(`Network Error: ${error.message}`);
            }
        }
        
        // Start real-time simulation
        function startSimulation() {
            if (simulationInterval) {
                log('‚ö†Ô∏è Simulation already running');
                return;
            }
            
            updateStatus('Starting real-time simulation...');
            log('üöÄ Starting real-time candle simulation');
            
            // Update every 5 seconds to simulate real-time updates
            simulationInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/latest_bar/${TEST_SYMBOL}`);
                    const data = await response.json();
                    
                    if (data.success && data.bar) {
                        // Log candle information
                        const barTime = new Date(data.bar.time * 1000).toLocaleTimeString();
                        const isNew = data.is_new_candle ? 'üÜï NEW' : 'üîÑ UPDATE';
                        
                        log(`${isNew} candle at ${barTime}: O=${data.bar.open.toFixed(2)} H=${data.bar.high.toFixed(2)} L=${data.bar.low.toFixed(2)} C=${data.bar.close.toFixed(2)}`);
                        
                        // Update chart
                        if (candlestickSeries) {
                            candlestickSeries.update(data.bar);
                        }
                        
                        // Special handling for new candles
                        if (data.is_new_candle) {
                            log('üéØ NEW CANDLE DETECTED! This is real-time candle formation.');
                            updateStatus('Real-time simulation running - New candle detected!');
                        } else {
                            updateStatus('Real-time simulation running - Updating current candle...');
                        }
                    }
                } catch (error) {
                    log(`‚ùå Simulation error: ${error.message}`);
                }
            }, 5000); // Update every 5 seconds
            
            log('‚úÖ Real-time simulation started (5-second intervals)');
        }
        
        // Stop simulation
        function stopSimulation() {
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
                updateStatus('Real-time simulation stopped');
                log('‚èπÔ∏è Real-time simulation stopped');
            } else {
                log('‚ö†Ô∏è No simulation running');
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            log('üìà Real-time candlestick chart test initialized');
            log(`üéØ Using symbol: ${TEST_SYMBOL}`);
            log('üí° Click "Test Latest Bar API" to test single bar fetching');
            log('üí° Click "Test Realtime Bars API" to load recent chart data');
            log('üí° Click "Start Real-time Simulation" to see live candle updates');
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (chart) {
                chart.applyOptions({ width: document.getElementById('chartContainer').clientWidth });
            }
        });
    </script>
</body>
</html>