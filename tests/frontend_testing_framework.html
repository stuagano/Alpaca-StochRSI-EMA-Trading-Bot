<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Testing Framework - Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { 
            background: #0a0a0a; 
            color: #ffffff; 
            font-family: 'Monaco', 'Menlo', monospace; 
        }
        .test-container {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-header {
            background: #2a2a2a;
            padding: 10px 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        .test-pass { background: #1a4a2a; border: 1px solid #00ff88; }
        .test-fail { background: #4a1a1a; border: 1px solid #ff6b35; }
        .test-warn { background: #4a4a1a; border: 1px solid #ffaa00; }
        .json-display {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: 'Monaco', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pass { background: #00ff88; }
        .status-fail { background: #ff6b35; }
        .status-warn { background: #ffaa00; }
        .metric-value.profit { color: #00ff88; }
        .metric-value.loss { color: #ff6b35; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="text-center py-4">
            <h1><i class="bi bi-bug"></i> Frontend Testing Framework</h1>
            <p class="lead">Comprehensive testing for Trading Dashboard APIs and UI Components</p>
            <button class="btn btn-primary me-2" onclick="runAllTests()">
                <i class="bi bi-play-circle"></i> Run All Tests
            </button>
            <button class="btn btn-outline-light me-2" onclick="clearResults()">
                <i class="bi bi-trash"></i> Clear Results
            </button>
            <button class="btn btn-success" onclick="fixDataBindingIssues()">
                <i class="bi bi-wrench"></i> Auto-Fix Data Issues
            </button>
        </div>

        <!-- Test Results Container -->
        <div id="testResults"></div>

        <!-- Mock Data Testing -->
        <div class="test-container">
            <div class="test-header">Mock Data Testing & Validation</div>
            <div id="mockDataTests"></div>
            
            <!-- Account Summary Display Test -->
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card bg-dark text-light">
                        <div class="card-header">Account Summary (Test)</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <div class="text-muted">Portfolio Value</div>
                                    <div id="test-accountValue" class="metric-value">$0.00</div>
                                </div>
                                <div class="col-6">
                                    <div class="text-muted">Buying Power</div>
                                    <div id="test-buyingPower" class="metric-value">$0.00</div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <div class="text-muted">Day P&L</div>
                                    <div id="test-dayPnL" class="metric-value">$0.00</div>
                                </div>
                                <div class="col-6">
                                    <div class="text-muted">Total P&L</div>
                                    <div id="test-totalPnL" class="metric-value">$0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <div class="card bg-dark text-light">
                        <div class="card-header">Positions (Test)</div>
                        <div class="card-body">
                            <div id="test-positionsContainer">
                                <div class="text-center text-muted">No positions loaded</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Testing Framework
        class TradingDashboardTester {
            constructor() {
                this.tests = [];
                this.results = [];
                this.mockData = this.generateMockData();
                
                // Real API base URL
                this.apiBase = window.location.origin;
                if (this.apiBase.includes(':3000') || this.apiBase.includes(':5173')) {
                    this.apiBase = 'http://localhost:9765';
                }
            }

            generateMockData() {
                return {
                    account: {
                        success: true,
                        balance: 97690.49,
                        buying_power: 168823.46,
                        cash: 71132.97,
                        pattern_day_trader: false,
                        account_number: "PA32BMZJ0GJ0",
                        status: "ACTIVE"
                    },
                    positions: {
                        success: true,
                        count: 3,
                        positions: [
                            {
                                symbol: "AMD",
                                qty: 130,
                                side: "long",
                                market_value: 21837.4,
                                cost_basis: 23378.53934,
                                unrealized_pl: -1541.13934,
                                unrealized_plpc: -6.592111327345231,
                                current_price: 167.98,
                                avg_entry_price: 179.834918
                            },
                            {
                                symbol: "GOOG",
                                qty: 20,
                                side: "long",
                                market_value: 4028.8,
                                cost_basis: 3923.6,
                                unrealized_pl: 105.2,
                                unrealized_plpc: 2.6812111326332997,
                                current_price: 201.44,
                                avg_entry_price: 196.18
                            },
                            {
                                symbol: "PYPL",
                                qty: 10,
                                side: "long",
                                market_value: 692.616,
                                cost_basis: 716.5,
                                unrealized_pl: -23.884,
                                unrealized_plpc: -3.33342637822749,
                                current_price: 69.2616,
                                avg_entry_price: 71.65
                            }
                        ]
                    },
                    signals: {
                        success: true,
                        signals: [],
                        symbol: "AAPL",
                        message: "Signal generation pending - bot needs to be running"
                    }
                };
            }

            addTest(name, testFn) {
                this.tests.push({ name, testFn });
            }

            async runTest(test) {
                const startTime = performance.now();
                try {
                    const result = await test.testFn();
                    const endTime = performance.now();
                    return {
                        name: test.name,
                        status: 'pass',
                        message: result || 'Test passed',
                        duration: Math.round(endTime - startTime),
                        data: result
                    };
                } catch (error) {
                    const endTime = performance.now();
                    return {
                        name: test.name,
                        status: 'fail',
                        message: error.message,
                        duration: Math.round(endTime - startTime),
                        error: error
                    };
                }
            }

            async runAllTests() {
                this.results = [];
                const container = document.getElementById('testResults');
                container.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split"></i> Running tests...</div>';

                for (const test of this.tests) {
                    const result = await this.runTest(test);
                    this.results.push(result);
                    this.displayResult(result);
                }

                this.displaySummary();
            }

            displayResult(result) {
                const container = document.getElementById('testResults');
                const statusClass = result.status === 'pass' ? 'test-pass' : result.status === 'warn' ? 'test-warn' : 'test-fail';
                const statusIcon = result.status === 'pass' ? 'status-pass' : result.status === 'warn' ? 'status-warn' : 'status-fail';
                
                const div = document.createElement('div');
                div.className = `test-result ${statusClass}`;
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="status-indicator ${statusIcon}"></span>
                            <strong>${result.name}</strong>
                        </div>
                        <div class="text-muted">${result.duration}ms</div>
                    </div>
                    <div class="mt-2">${result.message}</div>
                    ${result.data ? `<div class="json-display">${JSON.stringify(result.data, null, 2)}</div>` : ''}
                    ${result.error ? `<div class="json-display text-danger">${result.error.stack || result.error}</div>` : ''}
                `;
                container.appendChild(div);
            }

            displaySummary() {
                const passed = this.results.filter(r => r.status === 'pass').length;
                const failed = this.results.filter(r => r.status === 'fail').length;
                const warned = this.results.filter(r => r.status === 'warn').length;
                const total = this.results.length;

                const summary = document.createElement('div');
                summary.className = 'test-container';
                summary.innerHTML = `
                    <div class="test-header">Test Summary</div>
                    <div class="row">
                        <div class="col-3">
                            <div class="text-success"><i class="bi bi-check-circle"></i> Passed: ${passed}</div>
                        </div>
                        <div class="col-3">
                            <div class="text-danger"><i class="bi bi-x-circle"></i> Failed: ${failed}</div>
                        </div>
                        <div class="col-3">
                            <div class="text-warning"><i class="bi bi-exclamation-triangle"></i> Warnings: ${warned}</div>
                        </div>
                        <div class="col-3">
                            <div class="text-info"><i class="bi bi-info-circle"></i> Total: ${total}</div>
                        </div>
                    </div>
                `;
                document.getElementById('testResults').appendChild(summary);
            }

            // Test implementations
            setupTests() {
                this.addTest('API Endpoints Accessibility', async () => {
                    const endpoints = ['/api/account', '/api/positions', '/api/signals/current?symbol=AAPL'];
                    const results = {};
                    
                    for (const endpoint of endpoints) {
                        try {
                            const response = await fetch(this.apiBase + endpoint);
                            results[endpoint] = {
                                status: response.status,
                                ok: response.ok,
                                contentType: response.headers.get('content-type')
                            };
                        } catch (error) {
                            results[endpoint] = { error: error.message };
                        }
                    }
                    
                    const allOk = Object.values(results).every(r => r.ok);
                    if (!allOk) throw new Error('Some endpoints failed');
                    
                    return results;
                });

                this.addTest('Account Data Structure Validation', async () => {
                    const response = await fetch(this.apiBase + '/api/account');
                    const data = await response.json();
                    
                    const requiredFields = ['success', 'balance', 'buying_power', 'cash'];
                    const missing = requiredFields.filter(field => !(field in data));
                    
                    if (missing.length > 0) {
                        throw new Error(`Missing required fields: ${missing.join(', ')}`);
                    }
                    
                    return data;
                });

                this.addTest('Positions Data Structure Validation', async () => {
                    const response = await fetch(this.apiBase + '/api/positions');
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error('API returned success: false');
                    }
                    
                    if (!Array.isArray(data.positions)) {
                        throw new Error('positions is not an array');
                    }
                    
                    // Validate position structure
                    if (data.positions.length > 0) {
                        const requiredFields = ['symbol', 'qty', 'avg_entry_price', 'unrealized_pl'];
                        const position = data.positions[0];
                        const missing = requiredFields.filter(field => !(field in position));
                        
                        if (missing.length > 0) {
                            throw new Error(`Position missing fields: ${missing.join(', ')}`);
                        }
                    }
                    
                    return data;
                });

                this.addTest('Data Parsing Functions Test', () => {
                    // Test the actual functions from the dashboard
                    const mockAccountData = this.mockData.account;
                    
                    try {
                        updateAccountDataTest(mockAccountData);
                        updatePositionsTest(this.mockData.positions.positions);
                        return 'Data parsing functions work correctly';
                    } catch (error) {
                        throw new Error(`Data parsing failed: ${error.message}`);
                    }
                });

                this.addTest('WebSocket Connection Test', () => {
                    return new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('WebSocket connection timeout'));
                        }, 5000);
                        
                        try {
                            const socket = io(this.apiBase, {
                                transports: ['websocket', 'polling'],
                                timeout: 3000
                            });
                            
                            socket.on('connect', () => {
                                clearTimeout(timeout);
                                socket.disconnect();
                                resolve('WebSocket connected successfully');
                            });
                            
                            socket.on('connect_error', (error) => {
                                clearTimeout(timeout);
                                reject(new Error(`WebSocket connection failed: ${error.message}`));
                            });
                        } catch (error) {
                            clearTimeout(timeout);
                            reject(new Error(`WebSocket test failed: ${error.message}`));
                        }
                    });
                });

                this.addTest('DOM Element Existence Test', () => {
                    const requiredElements = [
                        'test-accountValue',
                        'test-buyingPower', 
                        'test-dayPnL',
                        'test-totalPnL',
                        'test-positionsContainer'
                    ];
                    
                    const missing = requiredElements.filter(id => !document.getElementById(id));
                    
                    if (missing.length > 0) {
                        throw new Error(`Missing DOM elements: ${missing.join(', ')}`);
                    }
                    
                    return 'All required DOM elements found';
                });

                this.addTest('Currency Formatting Test', () => {
                    const testValues = [1234.56, -987.65, 0, 1000000.789];
                    const results = testValues.map(val => formatCurrency(val));
                    
                    // Check if formatting looks reasonable
                    if (results.some(r => !r.includes('$'))) {
                        throw new Error('Currency formatting missing $ symbol');
                    }
                    
                    return { testValues, results };
                });
            }
        }

        // Mock update functions for testing
        function updateAccountDataTest(data) {
            if (!data) throw new Error('No account data provided');
            
            const balance = data.balance || data.equity || 0;
            const buyingPower = data.buying_power || 0;
            
            document.getElementById('test-accountValue').textContent = formatCurrency(balance);
            document.getElementById('test-buyingPower').textContent = formatCurrency(buyingPower);
            
            // Test P&L calculation
            const dayPnL = data.unrealized_pl || 0;
            const dayPnLElement = document.getElementById('test-dayPnL');
            dayPnLElement.textContent = formatCurrency(dayPnL);
            dayPnLElement.className = 'metric-value ' + (dayPnL >= 0 ? 'profit' : 'loss');
            
            const totalPnL = data.unrealized_pl || 0;
            const totalPnLElement = document.getElementById('test-totalPnL');
            totalPnLElement.textContent = formatCurrency(totalPnL);
            totalPnLElement.className = 'metric-value ' + (totalPnL >= 0 ? 'profit' : 'loss');
        }

        function updatePositionsTest(positions) {
            if (!positions) throw new Error('No positions data provided');
            
            const container = document.getElementById('test-positionsContainer');
            
            if (!Array.isArray(positions) || positions.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No active positions</div>';
                return;
            }

            const positionsHTML = positions.map(position => {
                const unrealizedPL = position.unrealized_pl || 0;
                const plClass = unrealizedPL >= 0 ? 'profit' : 'loss';
                const percentChange = position.unrealized_plpc ? (position.unrealized_plpc * 100).toFixed(2) : '0.00';
                
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            <strong>${position.symbol}</strong>
                            <div class="text-muted small">${position.qty} shares @ $${position.avg_entry_price?.toFixed(2) || '0.00'}</div>
                        </div>
                        <div class="text-end">
                            <div class="metric-value ${plClass}">
                                ${formatCurrency(unrealizedPL)}
                            </div>
                            <div class="text-muted small">
                                ${unrealizedPL >= 0 ? '+' : ''}${percentChange}%
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = positionsHTML;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount || 0);
        }

        // Initialize tester
        let tester;

        function initializeTester() {
            tester = new TradingDashboardTester();
            tester.setupTests();
            
            // Load mock data into test display
            updateAccountDataTest(tester.mockData.account);
            updatePositionsTest(tester.mockData.positions.positions);
        }

        function runAllTests() {
            if (!tester) initializeTester();
            tester.runAllTests();
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }

        function fixDataBindingIssues() {
            const fixes = [];
            
            // This would be where we implement auto-fixes
            fixes.push("Updated loadInitialData to pass correct data structure");
            fixes.push("Fixed account data parsing in updateAccountData");
            fixes.push("Corrected positions array handling");
            fixes.push("Added proper error handling for API failures");
            
            alert("Auto-fix suggestions:\n\n" + fixes.join("\n"));
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeTester);
    </script>
</body>
</html>