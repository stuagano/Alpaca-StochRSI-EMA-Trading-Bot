<!DOCTYPE html>
<html>
<head>
    <title>Positions Frontend Debug Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #333; 
            color: white; 
        }
        .test-section {
            border: 1px solid #666;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .position-item {
            border-bottom: 1px solid #555;
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
        }
        .profit { color: #0f0; }
        .loss { color: #f55; }
        .debug-log {
            background: #222;
            padding: 10px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #555;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
        }
        button:hover { background: #0088ff; }
    </style>
</head>
<body>
    <h1>Frontend Positions Debug Test</h1>
    
    <div class="test-section">
        <h3>Test Controls</h3>
        <button onclick="testPositionsAPI()">Test Positions API</button>
        <button onclick="testAccountAPI()">Test Account API</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-section">
        <h3>Positions Display</h3>
        <div id="positionsContainer">
            <div>Loading positions...</div>
        </div>
    </div>

    <div class="test-section">
        <h3>Account Display</h3>
        <div id="accountContainer">
            <div>Loading account...</div>
        </div>
    </div>

    <div class="test-section">
        <h3>Debug Log</h3>
        <div id="debugLog" class="debug-log"></div>
    </div>

    <script>
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        function formatCurrency(value) {
            if (typeof value !== 'number' || isNaN(value)) {
                return '$0.00';
            }
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(value);
        }

        function testPositionsAPI() {
            log('üß™ Testing Positions API...');
            
            fetch('/api/positions')
                .then(response => {
                    log(`üìà Response status: ${response.status} ${response.statusText}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    log('üìà Raw API Response:');
                    log(JSON.stringify(data, null, 2));
                    updatePositionsDisplay(data);
                })
                .catch(error => {
                    log(`‚ùå Positions API Error: ${error.message}`);
                });
        }

        function testAccountAPI() {
            log('üí∞ Testing Account API...');
            
            fetch('/api/account')
                .then(response => {
                    log(`üí∞ Response status: ${response.status} ${response.statusText}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    log('üí∞ Raw API Response:');
                    log(JSON.stringify(data, null, 2));
                    updateAccountDisplay(data);
                })
                .catch(error => {
                    log(`‚ùå Account API Error: ${error.message}`);
                });
        }

        function updatePositionsDisplay(positionsData) {
            log('üìà Updating positions display...');
            const container = document.getElementById('positionsContainer');
            
            let positions = [];
            
            if (positionsData && positionsData.success && positionsData.positions) {
                positions = positionsData.positions;
                log(`üìà Found ${positions.length} positions in API response`);
            } else if (Array.isArray(positionsData)) {
                positions = positionsData;
                log(`üìà API response is array with ${positions.length} positions`);
            } else {
                log('‚ö†Ô∏è Invalid positions data structure');
                log(`Data type: ${typeof positionsData}`);
                log(`Data keys: ${Object.keys(positionsData || {}).join(', ')}`);
            }
            
            if (!positions || !Array.isArray(positions) || positions.length === 0) {
                log('üìà No positions to display');
                container.innerHTML = '<div>No positions found</div>';
                return;
            }

            const positionsHtml = positions.map((position, index) => {
                log(`üìà Processing position ${index + 1}: ${position.symbol}`);
                
                const qty = parseFloat(position.qty || 0);
                const marketValue = parseFloat(position.market_value || 0);
                const unrealizedPL = parseFloat(position.unrealized_pl || 0);
                const unrealizedPLPercent = parseFloat(position.unrealized_plpc || 0) * 100;
                const avgEntryPrice = parseFloat(position.avg_entry_price || 0);
                const currentPrice = parseFloat(position.current_price || position.market_value / qty || 0);
                
                const plClass = unrealizedPL >= 0 ? 'profit' : 'loss';
                const side = position.side === 'short' ? 'SHORT' : 'LONG';
                
                log(`üìà ${position.symbol}: ${qty} shares, P&L: ${formatCurrency(unrealizedPL)}, %: ${unrealizedPLPercent.toFixed(2)}%`);
                
                return `
                    <div class="position-item">
                        <div>
                            <div><strong>${position.symbol}</strong> (${side})</div>
                            <div>${Math.abs(qty)} shares @ $${avgEntryPrice.toFixed(2)}</div>
                            <div>Current: $${currentPrice.toFixed(2)}</div>
                        </div>
                        <div>
                            <div class="${plClass}">${formatCurrency(unrealizedPL)}</div>
                            <div class="${plClass}">${unrealizedPLPercent >= 0 ? '+' : ''}${unrealizedPLPercent.toFixed(2)}%</div>
                            <div>MV: ${formatCurrency(marketValue)}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            log('‚úÖ Positions display updated successfully');
            container.innerHTML = positionsHtml;
        }

        function updateAccountDisplay(accountData) {
            log('üí∞ Updating account display...');
            const container = document.getElementById('accountContainer');
            
            if (!accountData || !accountData.success) {
                log('‚ùå Invalid account data structure');
                container.innerHTML = '<div>Error loading account data</div>';
                return;
            }
            
            const portfolioValue = parseFloat(accountData.balance || 0);
            const buyingPower = parseFloat(accountData.buying_power || 0);
            const cash = parseFloat(accountData.cash || 0);
            
            log(`üí∞ Portfolio: ${formatCurrency(portfolioValue)}, Buying Power: ${formatCurrency(buyingPower)}, Cash: ${formatCurrency(cash)}`);
            
            container.innerHTML = `
                <div>Portfolio Value: ${formatCurrency(portfolioValue)}</div>
                <div>Buying Power: ${formatCurrency(buyingPower)}</div>
                <div>Cash Available: ${formatCurrency(cash)}</div>
                <div>Status: ${accountData.status}</div>
            `;
        }

        // Auto-run tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Frontend Debug Test Page Loaded');
            setTimeout(() => {
                testPositionsAPI();
                testAccountAPI();
            }, 1000);
        });
    </script>
</body>
</html>