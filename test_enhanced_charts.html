<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Chart Test - StochRSI + EMA</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #0d1117;
            color: #c9d1d9;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1f6feb 0%, #8b5cf6 100%);
            border-radius: 12px;
        }
        
        .chart-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-wrapper {
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .indicator-wrapper {
            height: 200px;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .btn {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #30363d;
            border-color: #1f6feb;
        }
        
        .btn.active {
            background: #1f6feb;
            border-color: #1f6feb;
            color: white;
        }
        
        .status {
            text-align: center;
            padding: 15px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .status.loading {
            border-color: #fd7e14;
            color: #fd7e14;
        }
        
        .status.success {
            border-color: #26a641;
            color: #26a641;
        }
        
        .status.error {
            border-color: #f85149;
            color: #f85149;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 0.875rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .legend-color {
            width: 12px;
            height: 3px;
            border-radius: 2px;
        }
        
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #f0f6fc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“ˆ Enhanced Chart Test</h1>
            <p>StochRSI + EMA Strategy Visualization</p>
        </div>
        
        <div class="controls">
            <button class="btn active" onclick="loadSymbol('SPY')">SPY</button>
            <button class="btn" onclick="loadSymbol('AAPL')">AAPL</button>
            <button class="btn" onclick="loadSymbol('TSLA')">TSLA</button>
            <button class="btn" onclick="loadSymbol('AMD')">AMD</button>
            <button class="btn" onclick="testRealtimeUpdate()">Test Real-time</button>
        </div>
        
        <div id="status" class="status loading">
            Initializing charts...
        </div>
        
        <!-- Main Price Chart -->
        <div class="chart-container">
            <div class="chart-title">ðŸ’¹ Price Chart with EMA & Signals</div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #26a641;"></div>
                    <span>Bullish Candle</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f85149;"></div>
                    <span>Bearish Candle</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #1f6feb;"></div>
                    <span>EMA(20)</span>
                </div>
            </div>
            <div id="priceChart" class="chart-wrapper"></div>
        </div>
        
        <!-- StochRSI Indicator -->
        <div class="chart-container">
            <div class="chart-title">âš¡ StochRSI Oscillator</div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b;"></div>
                    <span>%K Line</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8b5cf6;"></div>
                    <span>%D Line</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f85149;"></div>
                    <span>Overbought (80)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #26a641;"></div>
                    <span>Oversold (20)</span>
                </div>
            </div>
            <div id="stochRSIChart" class="indicator-wrapper"></div>
        </div>
        
        <!-- Volume Chart -->
        <div class="chart-container">
            <div class="chart-title">ðŸ“Š Volume</div>
            <div id="volumeChart" class="indicator-wrapper"></div>
        </div>
    </div>

    <script>
        // Global variables
        let priceChart;
        let stochRSIChart;
        let volumeChart;
        let candlestickSeries;
        let emaSeries;
        let stochKSeries;
        let stochDSeries;
        let volumeSeries;
        let currentSymbol = 'SPY';
        
        // Chart colors
        const colors = {
            up: '#26a641',
            down: '#f85149',
            ema: '#1f6feb',
            stochK: '#f59e0b',
            stochD: '#8b5cf6',
            volume: '#656d76',
            overbought: '#f85149',
            oversold: '#26a641'
        };
        
        // Initialize charts
        function initCharts() {
            try {
                updateStatus('Initializing charts...', 'loading');
                
                // Price Chart
                priceChart = LightweightCharts.createChart(document.getElementById('priceChart'), {
                    width: document.getElementById('priceChart').clientWidth,
                    height: 400,
                    layout: {
                        background: { color: '#0d1117' },
                        textColor: '#c9d1d9',
                        fontSize: 12
                    },
                    grid: {
                        vertLines: { color: 'rgba(48, 54, 61, 0.5)' },
                        horzLines: { color: 'rgba(48, 54, 61, 0.5)' }
                    },
                    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                    timeScale: { timeVisible: true, secondsVisible: false },
                    rightPriceScale: { borderColor: 'rgba(125, 133, 144, 0.5)' }
                });
                
                // Add candlestick series
                candlestickSeries = priceChart.addCandlestickSeries({
                    upColor: colors.up,
                    downColor: colors.down,
                    borderVisible: false,
                    wickUpColor: colors.up,
                    wickDownColor: colors.down
                });
                
                // Add EMA series
                emaSeries = priceChart.addLineSeries({
                    color: colors.ema,
                    lineWidth: 2,
                    title: 'EMA(20)'
                });
                
                // StochRSI Chart
                stochRSIChart = LightweightCharts.createChart(document.getElementById('stochRSIChart'), {
                    width: document.getElementById('stochRSIChart').clientWidth,
                    height: 200,
                    layout: {
                        background: { color: '#0d1117' },
                        textColor: '#c9d1d9',
                        fontSize: 11
                    },
                    grid: {
                        vertLines: { color: 'rgba(48, 54, 61, 0.3)' },
                        horzLines: { color: 'rgba(48, 54, 61, 0.3)' }
                    },
                    timeScale: { visible: false },
                    rightPriceScale: { scaleMargins: { top: 0.1, bottom: 0.1 } }
                });
                
                // Add StochRSI series
                stochKSeries = stochRSIChart.addLineSeries({
                    color: colors.stochK,
                    lineWidth: 2,
                    title: '%K'
                });
                
                stochDSeries = stochRSIChart.addLineSeries({
                    color: colors.stochD,
                    lineWidth: 2,
                    title: '%D'
                });
                
                // Add reference lines
                const currentTime = Math.floor(Date.now() / 1000);
                const timeRange = 86400;
                
                stochRSIChart.addLineSeries({
                    color: colors.overbought,
                    lineWidth: 1,
                    lineStyle: LightweightCharts.LineStyle.Dashed
                }).setData([
                    { time: currentTime - timeRange, value: 80 },
                    { time: currentTime, value: 80 }
                ]);
                
                stochRSIChart.addLineSeries({
                    color: colors.oversold,
                    lineWidth: 1,
                    lineStyle: LightweightCharts.LineStyle.Dashed
                }).setData([
                    { time: currentTime - timeRange, value: 20 },
                    { time: currentTime, value: 20 }
                ]);
                
                // Volume Chart
                volumeChart = LightweightCharts.createChart(document.getElementById('volumeChart'), {
                    width: document.getElementById('volumeChart').clientWidth,
                    height: 200,
                    layout: {
                        background: { color: '#0d1117' },
                        textColor: '#c9d1d9',
                        fontSize: 11
                    },
                    grid: {
                        vertLines: { visible: false },
                        horzLines: { color: 'rgba(48, 54, 61, 0.3)' }
                    },
                    timeScale: { visible: false },
                    rightPriceScale: { scaleMargins: { top: 0.1, bottom: 0 } }
                });
                
                volumeSeries = volumeChart.addHistogramSeries({
                    color: colors.volume,
                    priceFormat: { type: 'volume' }
                });
                
                updateStatus('Charts initialized successfully', 'success');
                
                // Load initial data
                loadSymbol('SPY');
                
            } catch (error) {
                console.error('Error initializing charts:', error);
                updateStatus('Failed to initialize charts: ' + error.message, 'error');
            }
        }
        
        // Update status display
        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        // Load symbol data
        async function loadSymbol(symbol) {
            try {
                updateStatus(`Loading data for ${symbol}...`, 'loading');
                
                // Update button states
                document.querySelectorAll('.btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent === symbol) {
                        btn.classList.add('active');
                    }
                });
                
                currentSymbol = symbol;
                
                // Test with basic chart endpoint first
                const response = await fetch(`/api/chart/${symbol}?timeframe=1Min&limit=100`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load data');
                }
                
                console.log('Loaded data:', data);
                
                // Update candlestick chart
                if (data.data && data.data.data) {
                    const candlesticks = data.data.data.map(candle => ({
                        time: candle.time,
                        open: parseFloat(candle.open),
                        high: parseFloat(candle.high),
                        low: parseFloat(candle.low),
                        close: parseFloat(candle.close)
                    }));
                    
                    candlestickSeries.setData(candlesticks);
                    
                    // Generate sample EMA data (for testing)
                    const emaData = generateSampleEMA(candlesticks);
                    emaSeries.setData(emaData);
                    
                    // Generate sample StochRSI data (for testing)
                    const stochData = generateSampleStochRSI(candlesticks);
                    stochKSeries.setData(stochData.k);
                    stochDSeries.setData(stochData.d);
                    
                    // Add sample volume data
                    const volumeData = candlesticks.map(candle => ({
                        time: candle.time,
                        value: Math.floor(Math.random() * 1000000) + 100000,
                        color: candle.close >= candle.open ? 
                            'rgba(38, 166, 65, 0.6)' : 'rgba(248, 81, 73, 0.6)'
                    }));
                    volumeSeries.setData(volumeData);
                    
                    // Add sample signal markers
                    const markers = generateSampleMarkers(candlesticks);
                    candlestickSeries.setMarkers(markers);
                    
                    updateStatus(`Successfully loaded ${symbol} with ${candlesticks.length} data points`, 'success');
                } else {
                    throw new Error('Invalid data format received');
                }
                
            } catch (error) {
                console.error('Error loading symbol:', error);
                updateStatus(`Failed to load ${symbol}: ${error.message}`, 'error');
            }
        }
        
        // Generate sample EMA data for testing
        function generateSampleEMA(candlesticks) {
            const period = 20;
            const emaData = [];
            let multiplier = 2 / (period + 1);
            let ema = null;
            
            candlesticks.forEach((candle, index) => {
                if (index === 0) {
                    ema = candle.close;
                } else {
                    ema = (candle.close * multiplier) + (ema * (1 - multiplier));
                }
                
                if (index >= period - 1) {
                    emaData.push({
                        time: candle.time,
                        value: parseFloat(ema.toFixed(4))
                    });
                }
            });
            
            return emaData;
        }
        
        // Generate sample StochRSI data for testing
        function generateSampleStochRSI(candlesticks) {
            const kData = [];
            const dData = [];
            
            candlesticks.forEach((candle, index) => {
                if (index >= 14) {
                    // Generate oscillating values between 0 and 100
                    const k = 50 + 30 * Math.sin(index * 0.1) + Math.random() * 10 - 5;
                    const d = k + Math.random() * 6 - 3;
                    
                    kData.push({
                        time: candle.time,
                        value: Math.max(0, Math.min(100, k))
                    });
                    
                    dData.push({
                        time: candle.time,
                        value: Math.max(0, Math.min(100, d))
                    });
                }
            });
            
            return { k: kData, d: dData };
        }
        
        // Generate sample signal markers
        function generateSampleMarkers(candlesticks) {
            const markers = [];
            
            candlesticks.forEach((candle, index) => {
                if (index > 20 && Math.random() < 0.05) {
                    const isBuy = Math.random() > 0.5;
                    markers.push({
                        time: candle.time,
                        position: isBuy ? 'belowBar' : 'aboveBar',
                        color: isBuy ? colors.up : colors.down,
                        shape: isBuy ? 'arrowUp' : 'arrowDown',
                        text: isBuy ? 'BUY' : 'SELL'
                    });
                }
            });
            
            return markers;
        }
        
        // Test real-time update
        async function testRealtimeUpdate() {
            updateStatus('Testing real-time update...', 'loading');
            
            try {
                const response = await fetch(`/api/latest_bar/${currentSymbol}`);
                const data = await response.json();
                
                if (data.success && data.bar) {
                    // Update the last candle
                    candlestickSeries.update(data.bar);
                    updateStatus('Real-time update successful', 'success');
                } else {
                    throw new Error(data.error || 'No real-time data available');
                }
            } catch (error) {
                console.error('Error testing real-time update:', error);
                updateStatus('Real-time update failed: ' + error.message, 'error');
            }
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (priceChart) {
                priceChart.applyOptions({ 
                    width: document.getElementById('priceChart').clientWidth 
                });
            }
            if (stochRSIChart) {
                stochRSIChart.applyOptions({ 
                    width: document.getElementById('stochRSIChart').clientWidth 
                });
            }
            if (volumeChart) {
                volumeChart.applyOptions({ 
                    width: document.getElementById('volumeChart').clientWidth 
                });
            }
        });
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing Enhanced Chart Test...');
            initCharts();
        });
    </script>
</body>
</html>