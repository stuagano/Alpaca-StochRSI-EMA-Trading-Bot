
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Diagnostic Tool</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            background: #0a0e1a;
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e3a8a, #7c3aed);
            border-radius: 12px;
        }
        .diagnostic-section {
            background: #111827;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #374151;
        }
        .chart-container {
            height: 400px;
            margin: 20px 0;
            background: #1f2937;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            color: #10b981;
        }
        .status.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
        }
        .status.warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid #f59e0b;
            color: #f59e0b;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        .log {
            background: #000;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Chart Diagnostic Tool</h1>
            <p>Diagnose and fix TradingView Lightweight Charts issues</p>
        </div>

        <!-- Library Test -->
        <div class="diagnostic-section">
            <h3>1. Library Loading Test</h3>
            <div id="libraryStatus" class="status warning">Testing...</div>
            <button onclick="testLibrary()">Test Library</button>
        </div>

        <!-- Chart Creation Test -->
        <div class="diagnostic-section">
            <h3>2. Chart Creation Test</h3>
            <div id="chartStatus" class="status warning">Not tested</div>
            <button onclick="testChartCreation()">Test Chart Creation</button>
            <div id="testChart" class="chart-container"></div>
        </div>

        <!-- Data Loading Test -->
        <div class="diagnostic-section">
            <h3>3. Data Loading Test</h3>
            <div id="dataStatus" class="status warning">Not tested</div>
            <button onclick="testDataLoading()">Test Data Loading</button>
            <button onclick="testAPI()">Test API Endpoint</button>
        </div>

        <!-- Real-time Test -->
        <div class="diagnostic-section">
            <h3>4. Real-time Updates Test</h3>
            <div id="realtimeStatus" class="status warning">Not tested</div>
            <button onclick="testRealtime()">Test Real-time Updates</button>
            <button onclick="stopRealtime()">Stop Updates</button>
        </div>

        <!-- Diagnostic Log -->
        <div class="diagnostic-section">
            <h3>5. Diagnostic Log</h3>
            <div id="diagnosticLog" class="log"></div>
            <button onclick="clearLog()">Clear Log</button>
            <button onclick="exportLog()">Export Log</button>
        </div>
    </div>

    <script>
        let chart = null;
        let candlestickSeries = null;
        let realtimeInterval = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('diagnosticLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logEntry);
        }

        function setStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function testLibrary() {
            log('Testing TradingView Lightweight Charts library...');
            
            try {
                if (typeof LightweightCharts === 'undefined') {
                    throw new Error('LightweightCharts is not defined');
                }
                
                const version = LightweightCharts.version || 'Unknown';
                log(`‚úÖ Library loaded successfully. Version: ${version}`);
                setStatus('libraryStatus', `‚úÖ Library loaded (v${version})`, 'success');
                
                // Test basic API
                const testMethods = ['createChart', 'LineStyle', 'CrosshairMode'];
                testMethods.forEach(method => {
                    if (typeof LightweightCharts[method] !== 'undefined') {
                        log(`‚úÖ Method ${method} available`);
                    } else {
                        log(`‚ö†Ô∏è Method ${method} not available`, 'warning');
                    }
                });
                
            } catch (error) {
                log(`‚ùå Library test failed: ${error.message}`, 'error');
                setStatus('libraryStatus', `‚ùå Library failed: ${error.message}`, 'error');
            }
        }

        function testChartCreation() {
            log('Testing chart creation...');
            
            try {
                const container = document.getElementById('testChart');
                container.innerHTML = ''; // Clear previous chart
                
                chart = LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: 400,
                    layout: {
                        background: { color: '#1f2937' },
                        textColor: '#ffffff'
                    },
                    grid: {
                        vertLines: { color: '#374151' },
                        horzLines: { color: '#374151' }
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal
                    },
                    timeScale: {
                        timeVisible: true,
                        secondsVisible: false
                    }
                });
                
                candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#10b981',
                    downColor: '#ef4444',
                    borderUpColor: '#10b981',
                    borderDownColor: '#ef4444',
                    wickUpColor: '#10b981',
                    wickDownColor: '#ef4444'
                });
                
                log('‚úÖ Chart created successfully');
                setStatus('chartStatus', '‚úÖ Chart created successfully', 'success');
                
            } catch (error) {
                log(`‚ùå Chart creation failed: ${error.message}`, 'error');
                setStatus('chartStatus', `‚ùå Chart creation failed: ${error.message}`, 'error');
            }
        }

        function testDataLoading() {
            log('Testing data loading...');
            
            if (!chart || !candlestickSeries) {
                log('‚ùå Chart not created yet. Please run chart creation test first.', 'error');
                setStatus('dataStatus', '‚ùå Chart not ready', 'error');
                return;
            }
            
            try {
                // Generate sample data
                const sampleData = generateSampleData(50);
                
                candlestickSeries.setData(sampleData);
                
                log(`‚úÖ Data loaded successfully: ${sampleData.length} points`);
                setStatus('dataStatus', `‚úÖ Data loaded: ${sampleData.length} points`, 'success');
                
            } catch (error) {
                log(`‚ùå Data loading failed: ${error.message}`, 'error');
                setStatus('dataStatus', `‚ùå Data loading failed: ${error.message}`, 'error');
            }
        }

        function testAPI() {
            log('Testing API endpoint...');
            
            fetch('/api/v2/chart-test/SPY')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        log(`‚úÖ API test successful: ${data.data?.length || 0} data points`);
                        
                        if (candlestickSeries && data.data) {
                            candlestickSeries.setData(data.data);
                            log('‚úÖ API data loaded into chart');
                        }
                    } else {
                        throw new Error(data.error || 'API returned error');
                    }
                })
                .catch(error => {
                    log(`‚ùå API test failed: ${error.message}`, 'error');
                });
        }

        function testRealtime() {
            log('Testing real-time updates...');
            
            if (!chart || !candlestickSeries) {
                log('‚ùå Chart not ready for real-time test', 'error');
                setStatus('realtimeStatus', '‚ùå Chart not ready', 'error');
                return;
            }
            
            try {
                let updateCount = 0;
                realtimeInterval = setInterval(() => {
                    const newCandle = generateLatestCandle();
                    candlestickSeries.update(newCandle);
                    updateCount++;
                    
                    if (updateCount % 5 === 0) {
                        log(`üìä Real-time update ${updateCount}`);
                    }
                }, 1000);
                
                log('‚úÖ Real-time updates started');
                setStatus('realtimeStatus', '‚úÖ Real-time updates active', 'success');
                
            } catch (error) {
                log(`‚ùå Real-time test failed: ${error.message}`, 'error');
                setStatus('realtimeStatus', `‚ùå Real-time failed: ${error.message}`, 'error');
            }
        }

        function stopRealtime() {
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
                realtimeInterval = null;
                log('üõë Real-time updates stopped');
                setStatus('realtimeStatus', 'üõë Real-time updates stopped', 'warning');
            }
        }

        function generateSampleData(count) {
            const data = [];
            let basePrice = 150.0;
            const currentTime = Math.floor(Date.now() / 1000);
            
            for (let i = 0; i < count; i++) {
                const time = currentTime - (count - i) * 300; // 5-minute intervals
                
                const priceChange = (Math.random() - 0.5) * 2;
                const open = basePrice + priceChange;
                const high = open + Math.abs(Math.random() * 2);
                const low = open - Math.abs(Math.random() * 2);
                const close = low + (high - low) * Math.random();
                
                data.push({
                    time: time,
                    open: parseFloat(open.toFixed(2)),
                    high: parseFloat(high.toFixed(2)),
                    low: parseFloat(low.toFixed(2)),
                    close: parseFloat(close.toFixed(2))
                });
                
                basePrice = close;
            }
            
            return data;
        }

        function generateLatestCandle() {
            const currentTime = Math.floor(Date.now() / 1000);
            const basePrice = 150 + (Math.random() - 0.5) * 10;
            
            const open = basePrice;
            const high = open + Math.random() * 2;
            const low = open - Math.random() * 2;
            const close = low + (high - low) * Math.random();
            
            return {
                time: currentTime,
                open: parseFloat(open.toFixed(2)),
                high: parseFloat(high.toFixed(2)),
                low: parseFloat(low.toFixed(2)),
                close: parseFloat(close.toFixed(2))
            };
        }

        function clearLog() {
            document.getElementById('diagnosticLog').textContent = '';
        }

        function exportLog() {
            const log = document.getElementById('diagnosticLog').textContent;
            const blob = new Blob([log], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chart-diagnostic-${new Date().toISOString().slice(0,10)}.log`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Auto-run library test on load
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Chart Diagnostic Tool initialized');
            setTimeout(testLibrary, 500);
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            if (chart) {
                const container = document.getElementById('testChart');
                chart.applyOptions({ width: container.clientWidth });
            }
        });
    </script>
</body>
</html>
