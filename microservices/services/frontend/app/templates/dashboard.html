<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .navbar h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .nav-links a:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        .nav-links a.active {
            background-color: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        .card h3 {
            margin-bottom: 1rem;
            color: #333;
            font-weight: 600;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-healthy { background-color: #4caf50; }
        .status-degraded { background-color: #ff9800; }
        .status-unhealthy { background-color: #f44336; }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-value {
            font-weight: 600;
            color: #667eea;
        }
        
        .metric-positive {
            color: #4caf50 !important;
        }
        
        .metric-negative {
            color: #f44336 !important;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .error {
            color: #f44336;
            text-align: center;
            padding: 1rem;
            background-color: #ffebee;
            border-radius: 4px;
            margin: 1rem 0;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
        
        .service-list {
            list-style: none;
        }
        
        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .service-item:last-child {
            border-bottom: none;
        }
        
        .alert {
            background-color: #fff3cd;
            color: #856404;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            border-left: 4px solid #ffc107;
        }
        
        .alert.error {
            background-color: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }
        
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        
        .refresh-btn:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>Trading System Dashboard</h1>
        <div class="nav-links">
            <a href="/" class="active">Dashboard</a>
            <a href="/portfolio">Portfolio</a>
            <a href="/trading">Trading</a>
            <a href="/analytics">Analytics</a>
            <a href="/config">Config</a>
            <a href="/monitoring">Monitoring</a>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-grid">
            <!-- System Health Card -->
            <div class="card">
                <h3>System Health</h3>
                <div id="system-health" class="loading">Loading system health...</div>
                <button class="refresh-btn" onclick="loadSystemHealth()">Refresh</button>
            </div>

            <!-- Portfolio Summary Card -->
            <div class="card">
                <h3>Portfolio Summary</h3>
                <div id="portfolio-summary" class="loading">Loading portfolio...</div>
                <button class="refresh-btn" onclick="loadPortfolioSummary()">Refresh</button>
            </div>

            <!-- Account Information Card -->
            <div class="card">
                <h3>Account Information</h3>
                <div id="account-info" class="loading">Loading account info...</div>
                <button class="refresh-btn" onclick="loadAccountInfo()">Refresh</button>
            </div>

            <!-- Recent Trades Card -->
            <div class="card">
                <h3>Recent Trades</h3>
                <div id="recent-trades" class="loading">Loading trades...</div>
                <button class="refresh-btn" onclick="loadRecentTrades()">Refresh</button>
            </div>

            <!-- Service Status Card -->
            <div class="card">
                <h3>Service Status</h3>
                <div id="service-status" class="loading">Loading services...</div>
                <button class="refresh-btn" onclick="loadServiceStatus()">Refresh</button>
            </div>

            <!-- Alerts Card -->
            <div class="card">
                <h3>System Alerts</h3>
                <div id="system-alerts" class="loading">Loading alerts...</div>
                <button class="refresh-btn" onclick="loadSystemAlerts()">Refresh</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '{{ api_gateway_url }}';
        const WS_URL = '{{ websocket_url }}';

        // Load system health
        async function loadSystemHealth() {
            try {
                const response = await axios.get(`${API_BASE_URL}/health`);
                const health = response.data;
                
                let statusClass = 'status-healthy';
                let statusText = 'Healthy';
                
                if (health.status === 'degraded') {
                    statusClass = 'status-degraded';
                    statusText = 'Degraded';
                } else if (health.status === 'unhealthy') {
                    statusClass = 'status-unhealthy';
                    statusText = 'Unhealthy';
                }

                document.getElementById('system-health').innerHTML = `
                    <div class="metric">
                        <span>Overall Status</span>
                        <span><span class="status-indicator ${statusClass}"></span>${statusText}</span>
                    </div>
                    <div class="metric">
                        <span>Last Updated</span>
                        <span class="metric-value">${new Date().toLocaleTimeString()}</span>
                    </div>
                `;
            } catch (error) {
                document.getElementById('system-health').innerHTML = 
                    '<div class="error">Failed to load system health</div>';
            }
        }

        // Load portfolio summary
        async function loadPortfolioSummary() {
            try {
                const response = await axios.get(`${API_BASE_URL}/api/positions`);
                const positionsData = response.data;
                
                // Get portfolio metrics
                const metricsResponse = await axios.get(`${API_BASE_URL}/api/portfolio/metrics`);
                const metrics = metricsResponse.data;
                
                if (positionsData && metrics) {
                    const formatCurrency = (value) => new Intl.NumberFormat('en-US', { 
                        style: 'currency', 
                        currency: 'USD' 
                    }).format(value || 0);
                    
                    const totalPnL = positionsData.positions?.reduce((sum, pos) => sum + (pos.unrealized_pl || 0), 0) || 0;
                    const pnlClass = totalPnL >= 0 ? 'metric-positive' : 'metric-negative';
                    
                    document.getElementById('portfolio-summary').innerHTML = `
                        <div class="metric">
                            <span>Portfolio Value</span>
                            <span class="metric-value">${formatCurrency(metrics.total_value)}</span>
                        </div>
                        <div class="metric">
                            <span>Cash Balance</span>
                            <span class="metric-value">${formatCurrency(metrics.cash)}</span>
                        </div>
                        <div class="metric">
                            <span>Active Positions</span>
                            <span class="metric-value">${positionsData.count || 0}</span>
                        </div>
                        <div class="metric">
                            <span>Unrealized P&L</span>
                            <span class="metric-value ${pnlClass}">${formatCurrency(totalPnL)}</span>
                        </div>
                        <div class="metric">
                            <span>Buying Power</span>
                            <span class="metric-value">${formatCurrency(metrics.buying_power)}</span>
                        </div>
                        <div class="metric">
                            <span>Data Source</span>
                            <span class="metric-value" style="color: #4caf50;">${positionsData.data_source || 'unknown'}</span>
                        </div>
                    `;
                } else {
                    document.getElementById('portfolio-summary').innerHTML = 
                        '<div class="alert">Portfolio service unavailable</div>';
                }
            } catch (error) {
                document.getElementById('portfolio-summary').innerHTML = 
                    '<div class="error">Failed to load portfolio</div>';
            }
        }

        // Load account information
        async function loadAccountInfo() {
            try {
                const response = await axios.get(`${API_BASE_URL}/api/account`);
                const account = response.data;
                
                const formatCurrency = (value) => new Intl.NumberFormat('en-US', { 
                    style: 'currency', 
                    currency: 'USD' 
                }).format(value || 0);
                
                document.getElementById('account-info').innerHTML = `
                    <div class="metric">
                        <span>Account Status</span>
                        <span class="metric-value">${account.status || 'ACTIVE'}</span>
                    </div>
                    <div class="metric">
                        <span>Account ID</span>
                        <span class="metric-value">${(account.account_id || 'Unknown').substring(0, 8)}...</span>
                    </div>
                    <div class="metric">
                        <span>Buying Power</span>
                        <span class="metric-value">${formatCurrency(account.buying_power)}</span>
                    </div>
                    <div class="metric">
                        <span>Day Trade Buying Power</span>
                        <span class="metric-value">${formatCurrency(account.daytrading_buying_power)}</span>
                    </div>
                    <div class="metric">
                        <span>Pattern Day Trader</span>
                        <span class="metric-value">${account.pattern_day_trader ? 'Yes' : 'No'}</span>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading account info:', error);
                document.getElementById('account-info').innerHTML = 
                    '<div class="error">Failed to load account info</div>';
            }
        }

        // Load recent trades
        async function loadRecentTrades() {
            try {
                const response = await axios.get(`${API_BASE_URL}/api/orders`);
                const data = response.data;
                const orders = (data.orders || data || []).slice(0, 5); // Show last 5 orders
                
                if (orders.length > 0) {
                    const tradesHtml = orders.map(order => `
                        <div class="metric">
                            <span>${order.symbol} ${order.side}</span>
                            <span class="metric-value">${order.qty} @ $${order.filled_avg_price || order.limit_price}</span>
                        </div>
                    `).join('');
                    
                    document.getElementById('recent-trades').innerHTML = tradesHtml;
                } else {
                    document.getElementById('recent-trades').innerHTML = 
                        '<div class="alert">No recent trades</div>';
                }
            } catch (error) {
                document.getElementById('recent-trades').innerHTML = 
                    '<div class="error">Failed to load trades</div>';
            }
        }

        // Load service status
        async function loadServiceStatus() {
            try {
                const response = await axios.get(`${API_BASE_URL}/api/monitoring/system/health`);
                const health = response.data;
                
                const servicesHtml = Object.entries(health.services).map(([name, service]) => {
                    let statusClass = 'status-healthy';
                    if (service.status === 'degraded') statusClass = 'status-degraded';
                    else if (service.status === 'unhealthy' || service.status === 'error') statusClass = 'status-unhealthy';
                    
                    return `
                        <div class="service-item">
                            <span>${name}</span>
                            <span><span class="status-indicator ${statusClass}"></span>${service.status}</span>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('service-status').innerHTML = `
                    <ul class="service-list">
                        ${servicesHtml}
                    </ul>
                `;
            } catch (error) {
                document.getElementById('service-status').innerHTML = 
                    '<div class="error">Failed to load service status</div>';
            }
        }

        // Load system alerts
        async function loadSystemAlerts() {
            try {
                const response = await axios.get(`${API_BASE_URL}/api/monitoring/alerts`);
                const alerts = response.data.slice(0, 3); // Show top 3 alerts
                
                if (alerts.length > 0) {
                    const alertsHtml = alerts.map(alert => `
                        <div class="alert ${alert.severity === 'critical' ? 'error' : ''}">
                            <strong>${alert.service_name}</strong>: ${alert.message}
                        </div>
                    `).join('');
                    
                    document.getElementById('system-alerts').innerHTML = alertsHtml;
                } else {
                    document.getElementById('system-alerts').innerHTML = 
                        '<div class="alert">No active alerts</div>';
                }
            } catch (error) {
                document.getElementById('system-alerts').innerHTML = 
                    '<div class="error">Failed to load alerts</div>';
            }
        }

        // Auto-refresh data
        function autoRefresh() {
            loadSystemHealth();
            loadPortfolioSummary();
            loadAccountInfo();
            loadRecentTrades();
            loadServiceStatus();
            loadSystemAlerts();
        }

        // Initial load
        autoRefresh();

        // Refresh every 30 seconds
        setInterval(autoRefresh, 30000);

        // WebSocket connection for real-time updates
        if (WS_URL) {
            try {
                const ws = new WebSocket(WS_URL);
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    // Handle real-time updates
                    if (data.type === 'portfolio_update') {
                        loadPortfolioSummary();
                    } else if (data.type === 'order_update') {
                        loadRecentTrades();
                    } else if (data.type === 'alert') {
                        loadSystemAlerts();
                    }
                };
                
                ws.onerror = function(error) {
                    console.warn('WebSocket connection failed:', error);
                };
            } catch (error) {
                console.warn('WebSocket not supported or failed to connect');
            }
        }
    </script>
</body>
</html>