<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Debug Test</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { background: #1a1a2e; color: #eee; font-family: Arial, sans-serif; padding: 20px; }
        #chartContainer { width: 800px; height: 400px; margin: 20px 0; }
        .info { background: #2a2a4a; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #4a2a2a; }
        .success { background: #2a4a2a; }
    </style>
</head>
<body>
    <h1>üìà Chart Debug Test</h1>
    <div id="status" class="info">Initializing...</div>
    <div id="chartContainer"></div>
    <div id="dataInfo" class="info"></div>

    <script>
        let chart;
        let candlestickSeries;
        
        async function testCharts() {
            const statusEl = document.getElementById('status');
            const dataEl = document.getElementById('dataInfo');
            
            try {
                statusEl.innerHTML = 'üîÑ Loading chart data...';
                statusEl.className = 'info';
                
                // Fetch chart data
                const response = await fetch('/api/chart/SPY?timeframe=1Min&limit=10');
                const data = await response.json();
                
                console.log('API Response:', data);
                dataEl.innerHTML = `<strong>API Response:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                if (!data.success) {
                    throw new Error(data.error || 'API request failed');
                }
                
                if (!data.data || !data.data.data || data.data.data.length === 0) {
                    throw new Error('No chart data available');
                }
                
                statusEl.innerHTML = 'üìä Creating chart...';
                
                // Create chart
                const container = document.getElementById('chartContainer');
                chart = LightweightCharts.createChart(container, {
                    width: 800,
                    height: 400,
                    layout: {
                        background: { color: '#1a1a2e' },
                        textColor: '#d1d5db',
                    },
                    grid: {
                        vertLines: { color: 'rgba(42, 46, 57, 0.5)' },
                        horzLines: { color: 'rgba(42, 46, 57, 0.5)' },
                    },
                    timeScale: {
                        timeVisible: true,
                        secondsVisible: false,
                    },
                });
                
                candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#10b981',
                    downColor: '#ef4444',
                    borderVisible: false,
                    wickUpColor: '#10b981',
                    wickDownColor: '#ef4444',
                });
                
                statusEl.innerHTML = 'üîÑ Processing chart data...';
                
                // Process chart data
                const chartData = data.data.data.map((candle, index) => {
                    console.log(`Processing candle ${index}:`, candle);
                    
                    let timeValue = candle.time;
                    
                    // Log timestamp processing
                    console.log(`Timestamp processing: ${timeValue} (${typeof timeValue})`);
                    
                    // Convert timestamp to Date for debugging
                    const date = new Date(timeValue * 1000);
                    console.log(`Converted to date: ${date.toISOString()}`);
                    
                    return {
                        time: timeValue,
                        open: parseFloat(candle.open),
                        high: parseFloat(candle.high),
                        low: parseFloat(candle.low),
                        close: parseFloat(candle.close)
                    };
                });
                
                console.log('Processed chart data:', chartData);
                
                // Sort by time
                chartData.sort((a, b) => a.time - b.time);
                
                statusEl.innerHTML = 'üìà Setting chart data...';
                
                // Set data
                candlestickSeries.setData(chartData);
                
                statusEl.innerHTML = `‚úÖ Chart loaded successfully with ${chartData.length} candles`;
                statusEl.className = 'info success';
                
                // Add some debug info
                if (chartData.length > 0) {
                    const firstCandle = chartData[0];
                    const lastCandle = chartData[chartData.length - 1];
                    
                    dataEl.innerHTML += `<br><br><strong>Chart Data Summary:</strong><br>`;
                    dataEl.innerHTML += `‚Ä¢ Data points: ${chartData.length}<br>`;
                    dataEl.innerHTML += `‚Ä¢ First candle: ${new Date(firstCandle.time * 1000).toLocaleString()}<br>`;
                    dataEl.innerHTML += `‚Ä¢ Last candle: ${new Date(lastCandle.time * 1000).toLocaleString()}<br>`;
                    dataEl.innerHTML += `‚Ä¢ Price range: $${Math.min(...chartData.map(c => c.low)).toFixed(2)} - $${Math.max(...chartData.map(c => c.high)).toFixed(2)}`;
                }
                
            } catch (error) {
                console.error('Chart test failed:', error);
                statusEl.innerHTML = `‚ùå Error: ${error.message}`;
                statusEl.className = 'info error';
            }
        }
        
        // Start test when page loads
        window.addEventListener('load', testCharts);
    </script>
</body>
</html>