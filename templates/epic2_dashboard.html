<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic 2: Historical Data & Backtesting Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --dark-bg: #1f2937;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
        }

        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .metric-card {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border-left: 4px solid var(--primary-color);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background-color: var(--success-color); }
        .status-offline { background-color: var(--danger-color); }
        .status-warning { background-color: var(--warning-color); }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: #1d4ed8;
            border-color: #1d4ed8;
        }

        .feature-badge {
            background: linear-gradient(135deg, var(--success-color), #047857);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .log-entry {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            background: #f8fafc;
            border-left: 3px solid var(--primary-color);
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }

        .data-table {
            font-size: 0.875rem;
        }

        .data-table th {
            background: var(--dark-bg);
            color: white;
            font-weight: 600;
            padding: 12px 8px;
            border: none;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .epic2-header {
            background: linear-gradient(135deg, #1f2937, #374151);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .market-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .market-open {
            background: rgba(5, 150, 105, 0.1);
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }

        .market-closed {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger-color);
            border: 2px solid var(--danger-color);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-chart-line me-2"></i>
                Epic 2: Historical Data & Backtesting
            </a>
            <div class="navbar-nav ms-auto">
                <span class="nav-text text-light me-3">
                    <span id="marketStatus" class="market-status">
                        <i class="fas fa-circle me-1"></i>
                        Checking market status...
                    </span>
                </span>
                <span class="nav-text text-light">
                    <i class="far fa-clock me-1"></i>
                    <span id="currentTime"></span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Epic 2 Header -->
    <div class="epic2-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-history me-3"></i>
                        Historical Data & Backtesting System
                    </h1>
                    <p class="lead mb-0">
                        Professional-grade backtesting with 24/7 data access and comprehensive analytics
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="feature-badge me-2">
                        <i class="fas fa-clock me-1"></i>
                        24/7 Access
                    </span>
                    <span class="feature-badge">
                        <i class="fas fa-database me-1"></i>
                        Cached Data
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- System Status Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-value" id="systemStatus">
                            <i class="fas fa-check-circle text-success"></i>
                        </div>
                        <div class="metric-label">System Status</div>
                        <small class="text-muted" id="systemStatusText">Checking...</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-value" id="dataRecords">---</div>
                        <div class="metric-label">Historical Records</div>
                        <small class="text-muted">Total data points</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-value" id="symbolsCovered">---</div>
                        <div class="metric-label">Symbols Covered</div>
                        <small class="text-muted">Available symbols</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-value" id="cacheSize">---</div>
                        <div class="metric-label">Cache Size</div>
                        <small class="text-muted">MB stored locally</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Historical Data Panel -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-area me-2"></i>
                            Historical Data Visualization
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Controls -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="symbolSelect" class="form-label">Symbol</label>
                                <select class="form-select" id="symbolSelect">
                                    <option value="AAPL">AAPL</option>
                                    <option value="MSFT">MSFT</option>
                                    <option value="GOOGL">GOOGL</option>
                                    <option value="TSLA">TSLA</option>
                                    <option value="AMZN">AMZN</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="timeframeSelect" class="form-label">Timeframe</label>
                                <select class="form-select" id="timeframeSelect">
                                    <option value="1Min">1 Minute</option>
                                    <option value="5Min">5 Minutes</option>
                                    <option value="15Min">15 Minutes</option>
                                    <option value="1Hour">1 Hour</option>
                                    <option value="1Day" selected>1 Day</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="dateRange" class="form-label">Date Range</label>
                                <select class="form-select" id="dateRange">
                                    <option value="7">Last 7 days</option>
                                    <option value="30" selected>Last 30 days</option>
                                    <option value="90">Last 90 days</option>
                                    <option value="365">Last 1 year</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="loadChartData()">
                                    <i class="fas fa-sync-alt me-1"></i>
                                    Load Data
                                </button>
                            </div>
                        </div>

                        <!-- Chart -->
                        <div class="chart-container">
                            <canvas id="priceChart"></canvas>
                        </div>
                        <div class="loading-spinner" id="chartLoading"></div>

                        <!-- Chart Info -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <span id="chartInfo">Select symbol and click Load Data</span>
                                </small>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-outline-primary btn-sm" onclick="exportData()">
                                    <i class="fas fa-download me-1"></i>
                                    Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backtesting & Analytics -->
            <div class="col-lg-4">
                <!-- Backtesting Panel -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-flask me-2"></i>
                            Quick Backtest
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="backtestForm">
                            <div class="mb-3">
                                <label class="form-label">Strategy</label>
                                <select class="form-select" id="strategySelect">
                                    <option value="stochrsi">Stochastic RSI</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Symbols</label>
                                <input type="text" class="form-control" id="backtestSymbols" 
                                       value="AAPL,MSFT" placeholder="AAPL,MSFT,GOOGL">
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="backtestStartDate">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="backtestEndDate">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Initial Capital</label>
                                <input type="number" class="form-control" id="initialCapital" 
                                       value="100000" min="1000" step="1000">
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-play me-1"></i>
                                Run Backtest
                            </button>
                        </form>
                        <div class="loading-spinner" id="backtestLoading"></div>
                    </div>
                </div>

                <!-- Results Panel -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Backtest Results
                        </h6>
                    </div>
                    <div class="card-body" id="backtestResults">
                        <div class="text-center text-muted">
                            <i class="fas fa-chart-line fa-3x mb-3"></i>
                            <p>Run a backtest to see results</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Logs -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-terminal me-2"></i>
                            System Activity Log
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="systemLogs" style="max-height: 200px; overflow-y: auto;">
                            <div class="log-entry">
                                <span class="text-muted">[00:00:00]</span> Epic 2 system initialized
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let priceChart = null;
        const API_BASE = '/api/epic2';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            setInterval(updateTime, 1000);
            setInterval(checkSystemStatus, 30000); // Check every 30 seconds
        });

        function initializeDashboard() {
            updateTime();
            checkSystemStatus();
            initializeDateInputs();
            setupEventListeners();
            addLog('Dashboard initialized');
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
        }

        function initializeDateInputs() {
            const today = new Date();
            const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
            
            document.getElementById('backtestEndDate').value = today.toISOString().split('T')[0];
            document.getElementById('backtestStartDate').value = oneYearAgo.toISOString().split('T')[0];
        }

        function setupEventListeners() {
            document.getElementById('backtestForm').addEventListener('submit', handleBacktestSubmit);
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();
                
                if (response.ok) {
                    updateSystemStatus(data);
                    updateMarketStatus(data.market_open);
                } else {
                    throw new Error(data.error || 'Failed to get status');
                }
            } catch (error) {
                console.error('Status check failed:', error);
                document.getElementById('systemStatusText').textContent = 'Connection Error';
                addLog(`Status check failed: ${error.message}`, 'error');
            }
        }

        function updateSystemStatus(data) {
            document.getElementById('systemStatusText').textContent = data.status;
            
            if (data.data_stats) {
                document.getElementById('dataRecords').textContent = 
                    data.data_stats.total_records?.toLocaleString() || '---';
                document.getElementById('symbolsCovered').textContent = 
                    data.data_stats.symbols || '---';
                document.getElementById('cacheSize').textContent = 
                    data.data_stats.cache_size_mb ? data.data_stats.cache_size_mb.toFixed(1) : '---';
            }
        }

        function updateMarketStatus(isOpen) {
            const statusElement = document.getElementById('marketStatus');
            if (isOpen) {
                statusElement.className = 'market-status market-open';
                statusElement.innerHTML = '<i class="fas fa-circle me-1"></i>Market Open';
            } else {
                statusElement.className = 'market-status market-closed';
                statusElement.innerHTML = '<i class="fas fa-circle me-1"></i>Market Closed';
            }
        }

        async function loadChartData() {
            const symbol = document.getElementById('symbolSelect').value;
            const timeframe = document.getElementById('timeframeSelect').value;
            const days = document.getElementById('dateRange').value;
            
            showLoading('chartLoading');
            addLog(`Loading chart data for ${symbol} (${timeframe})`);
            
            try {
                const response = await fetch(`${API_BASE}/chart-data/${symbol}?timeframe=${timeframe}&limit=${days * 24}`);
                const data = await response.json();
                
                if (response.ok) {
                    renderChart(data);
                    addLog(`Loaded ${data.bars.length} bars for ${symbol}`);
                } else {
                    throw new Error(data.error || 'Failed to load chart data');
                }
            } catch (error) {
                console.error('Chart data error:', error);
                addLog(`Chart data error: ${error.message}`, 'error');
            } finally {
                hideLoading('chartLoading');
            }
        }

        function renderChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }
            
            const chartData = {
                labels: data.bars.map(bar => new Date(bar.time * 1000)),
                datasets: [{
                    label: 'Close Price',
                    data: data.bars.map(bar => bar.close),
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            };
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${data.symbol} - ${data.timeframe} (${data.data_source})`
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    day: 'MMM dd',
                                    hour: 'HH:mm'
                                }
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Price ($)'
                            }
                        }
                    }
                }
            });
            
            document.getElementById('chartInfo').textContent = 
                `${data.symbol} - ${data.bars.length} bars - Data: ${data.data_source} - Updated: ${new Date(data.last_update).toLocaleString()}`;
        }

        async function handleBacktestSubmit(e) {
            e.preventDefault();
            
            const formData = {
                strategy: document.getElementById('strategySelect').value,
                symbols: document.getElementById('backtestSymbols').value.split(',').map(s => s.trim()),
                start_date: document.getElementById('backtestStartDate').value,
                end_date: document.getElementById('backtestEndDate').value,
                timeframe: '1Day',
                config: {
                    initial_capital: parseFloat(document.getElementById('initialCapital').value)
                }
            };
            
            showLoading('backtestLoading');
            addLog(`Starting backtest: ${formData.strategy} on ${formData.symbols.join(', ')}`);
            
            try {
                const response = await fetch(`${API_BASE}/backtest/run`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayBacktestResults(data);
                    addLog(`Backtest completed: ${data.metrics.total_return?.toFixed(2)}% return`);
                } else {
                    throw new Error(data.error || 'Backtest failed');
                }
            } catch (error) {
                console.error('Backtest error:', error);
                addLog(`Backtest error: ${error.message}`, 'error');
                document.getElementById('backtestResults').innerHTML = 
                    `<div class="alert alert-danger">Backtest failed: ${error.message}</div>`;
            } finally {
                hideLoading('backtestLoading');
            }
        }

        function displayBacktestResults(data) {
            const metrics = data.metrics;
            const resultsHtml = `
                <div class="row g-2">
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <small class="text-muted d-block">Total Return</small>
                            <strong class="${metrics.total_return >= 0 ? 'text-success' : 'text-danger'}">
                                ${(metrics.total_return * 100).toFixed(2)}%
                            </strong>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <small class="text-muted d-block">Sharpe Ratio</small>
                            <strong>${metrics.sharpe_ratio?.toFixed(2) || 'N/A'}</strong>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <small class="text-muted d-block">Win Rate</small>
                            <strong>${(metrics.win_rate * 100).toFixed(1)}%</strong>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <small class="text-muted d-block">Max Drawdown</small>
                            <strong class="text-danger">${(metrics.max_drawdown * 100).toFixed(1)}%</strong>
                        </div>
                    </div>
                    <div class="col-12 mt-3">
                        <div class="p-2 bg-light rounded">
                            <small class="text-muted d-block">Summary</small>
                            <small>
                                ${data.trade_count} trades over ${data.symbols.join(', ')} 
                                (${data.period.start.split('T')[0]} to ${data.period.end.split('T')[0]})
                            </small>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('backtestResults').innerHTML = resultsHtml;
        }

        async function exportData() {
            const symbol = document.getElementById('symbolSelect').value;
            const timeframe = document.getElementById('timeframeSelect').value;
            
            addLog(`Exporting data for ${symbol}`);
            
            try {
                const url = `${API_BASE}/export/${symbol}?format=csv&timeframe=${timeframe}`;
                window.open(url, '_blank');
                addLog(`Data export initiated for ${symbol}`);
            } catch (error) {
                addLog(`Export error: ${error.message}`, 'error');
            }
        }

        function showLoading(elementId) {
            document.getElementById(elementId).style.display = 'block';
        }

        function hideLoading(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }

        function addLog(message, type = 'info') {
            const logsContainer = document.getElementById('systemLogs');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'error' ? 'text-danger' : 'text-info';
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="text-muted">[${timestamp}]</span> 
                <span class="${logClass}">${message}</span>
            `;
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            // Keep only last 20 log entries
            while (logsContainer.children.length > 20) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
        }
    </script>
</body>
</html>