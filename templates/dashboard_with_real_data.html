{% extends "unified_master_dashboard.html" %}

{% block content %}
<!-- Dashboard with Real Data -->
<div class="unified-grid grid-1">
    <!-- Portfolio Overview -->
    <div class="unified-card">
        <div class="card-header">
            <div class="card-title">
                <i class="bi bi-briefcase"></i>
                Portfolio Overview
            </div>
            <div class="card-actions">
                <button class="card-action" onclick="refreshPortfolio()">
                    <i class="bi bi-arrow-clockwise"></i>
                    Refresh
                </button>
            </div>
        </div>
        
        <div class="metric-grid">
            <div class="metric-card">
                <div class="metric-value" id="totalValue">$0.00</div>
                <div class="metric-label">Total Value</div>
                <div class="metric-change" id="totalValueChange">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="dayPL">$0.00</div>
                <div class="metric-label">Day P&L</div>
                <div class="metric-change" id="dayPLPct">0.00%</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="buyingPower">$0.00</div>
                <div class="metric-label">Buying Power</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="activePositions">0</div>
                <div class="metric-label">Active Positions</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="cashBalance">$0.00</div>
                <div class="metric-label">Cash</div>
            </div>
        </div>
    </div>
</div>

<!-- Main Dashboard Grid -->
<div class="unified-grid grid-2">
    <!-- Recent Trades -->
    <div class="unified-card">
        <div class="card-header">
            <div class="card-title">
                <i class="bi bi-clock-history"></i>
                Recent Trades
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Value</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="recentTradesTable">
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                Loading trades...
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Market Movers -->
    <div class="unified-card">
        <div class="card-header">
            <div class="card-title">
                <i class="bi bi-graph-up"></i>
                Market Movers
            </div>
        </div>
        
        <div id="marketMoversContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                Loading market data...
            </div>
        </div>
    </div>
</div>

<!-- Trading Signals & Performance -->
<div class="unified-grid grid-2">
    <!-- Trading Signals -->
    <div class="unified-card">
        <div class="card-header">
            <div class="card-title">
                <i class="bi bi-lightning"></i>
                Active Signals
            </div>
        </div>
        
        <div id="tradingSignalsContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                Loading signals...
            </div>
        </div>
    </div>
    
    <!-- Performance Metrics -->
    <div class="unified-card">
        <div class="card-header">
            <div class="card-title">
                <i class="bi bi-bar-chart"></i>
                Performance Metrics
            </div>
        </div>
        
        <div class="metric-grid">
            <div class="metric-card">
                <div class="metric-value" id="winRate">0.0%</div>
                <div class="metric-label">Win Rate</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="sharpeRatio">0.00</div>
                <div class="metric-label">Sharpe Ratio</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="maxDrawdown">0.00%</div>
                <div class="metric-label">Max Drawdown</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="totalTradesToday">0</div>
                <div class="metric-label">Trades Today</div>
            </div>
        </div>
    </div>
</div>

<!-- Status Information -->
<div class="unified-grid grid-1">
    <div class="unified-card">
        <div class="card-header">
            <div class="card-title">
                <i class="bi bi-info-circle"></i>
                System Status
            </div>
        </div>
        <div id="systemStatus">
            <div class="unified-alert alert-info">
                <i class="bi bi-info-circle"></i>
                <span>Dashboard loading real-time data...</span>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Dashboard Data Manager
class DashboardDataManager {
    constructor() {
        this.refreshInterval = 30000; // 30 seconds
        this.intervalId = null;
        this.apiBase = window.location.origin;
    }
    
    async init() {
        console.log('ðŸŽ¯ Initializing Dashboard Data Manager');
        await this.loadAllData();
        this.startAutoRefresh();
    }
    
    async loadAllData() {
        try {
            const response = await fetch(`${this.apiBase}/api/dashboard/stats`);
            const result = await response.json();
            
            if (result.success) {
                this.updatePortfolio(result.data.portfolio);
                this.updateRecentTrades(result.data.recent_trades);
                this.updateMarketMovers(result.data.market_movers);
                this.updateTradingSignals(result.data.trading_signals);
                this.updatePerformanceMetrics(result.data.performance_metrics);
                this.updateSystemStatus('success', 'Dashboard data loaded successfully');
            } else {
                throw new Error(result.error || 'Failed to load dashboard data');
            }
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            this.updateSystemStatus('error', `Error loading data: ${error.message}`);
        }
    }
    
    updatePortfolio(data) {
        if (!data) return;
        
        // Update portfolio values
        document.getElementById('totalValue').textContent = `$${data.total_value.toLocaleString()}`;
        document.getElementById('buyingPower').textContent = `$${data.buying_power.toLocaleString()}`;
        document.getElementById('activePositions').textContent = data.active_positions;
        document.getElementById('cashBalance').textContent = `$${data.cash.toLocaleString()}`;
        
        // Update day P&L with colors
        const dayPLElement = document.getElementById('dayPL');
        const dayPLPctElement = document.getElementById('dayPLPct');
        
        dayPLElement.textContent = `$${data.day_pl.toLocaleString()}`;
        dayPLPctElement.textContent = `${data.day_pl_pct > 0 ? '+' : ''}${data.day_pl_pct.toFixed(2)}%`;
        
        // Color coding
        const color = data.day_pl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
        dayPLElement.style.color = color;
        dayPLPctElement.style.color = color;
        dayPLPctElement.className = `metric-change ${data.day_pl >= 0 ? 'metric-positive' : 'metric-negative'}`;
    }
    
    updateRecentTrades(trades) {
        if (!trades || !Array.isArray(trades)) return;
        
        const tbody = document.getElementById('recentTradesTable');
        
        if (trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No recent trades</td></tr>';
            return;
        }
        
        tbody.innerHTML = trades.map(trade => `
            <tr>
                <td><strong>${trade.symbol}</strong></td>
                <td>
                    <span class="badge bg-${trade.side === 'buy' ? 'success' : 'danger'}">
                        ${trade.side.toUpperCase()}
                    </span>
                </td>
                <td>${trade.qty}</td>
                <td>$${trade.price.toFixed(2)}</td>
                <td>$${trade.value.toLocaleString()}</td>
                <td>${new Date(trade.time).toLocaleTimeString()}</td>
            </tr>
        `).join('');
    }
    
    updateMarketMovers(movers) {
        if (!movers || !Array.isArray(movers)) return;
        
        const container = document.getElementById('marketMoversContainer');
        
        if (movers.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">No market data available</div>';
            return;
        }
        
        container.innerHTML = movers.map(mover => `
            <div class="d-flex justify-content-between align-items-center mb-3 p-2" 
                 style="border: 1px solid var(--border-color); border-radius: 6px;">
                <div>
                    <strong>${mover.symbol}</strong>
                    <div class="small text-muted">$${mover.price.toFixed(2)}</div>
                </div>
                <div class="text-end">
                    <div class="${mover.change_pct >= 0 ? 'metric-positive' : 'metric-negative'}">
                        ${mover.change >= 0 ? '+' : ''}$${mover.change.toFixed(2)}
                    </div>
                    <div class="small ${mover.change_pct >= 0 ? 'metric-positive' : 'metric-negative'}">
                        ${mover.change_pct >= 0 ? '+' : ''}${mover.change_pct.toFixed(2)}%
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    updateTradingSignals(signals) {
        if (!signals || !Array.isArray(signals)) return;
        
        const container = document.getElementById('tradingSignalsContainer');
        
        if (signals.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">No active signals</div>';
            return;
        }
        
        container.innerHTML = signals.map(signal => `
            <div class="d-flex justify-content-between align-items-center mb-3 p-3" 
                 style="border: 1px solid var(--border-color); border-radius: 8px;">
                <div>
                    <div class="d-flex align-items-center gap-2">
                        <strong>${signal.symbol}</strong>
                        <span class="badge bg-${signal.signal === 'BUY' ? 'success' : 'danger'}">
                            ${signal.signal}
                        </span>
                    </div>
                    <div class="small text-muted mt-1">
                        Strength: ${signal.strength}% | Price: $${signal.price}
                    </div>
                </div>
                <div class="text-end">
                    <div class="small">Target: $${signal.target}</div>
                    <div class="small text-muted">Stop: $${signal.stop}</div>
                </div>
            </div>
        `).join('');
    }
    
    updatePerformanceMetrics(metrics) {
        if (!metrics) return;
        
        document.getElementById('winRate').textContent = `${metrics.win_rate}%`;
        document.getElementById('sharpeRatio').textContent = metrics.sharpe_ratio;
        document.getElementById('maxDrawdown').textContent = `${metrics.max_drawdown}%`;
        document.getElementById('totalTradesToday').textContent = metrics.total_trades_today;
        
        // Color coding for performance metrics
        const winRateElement = document.getElementById('winRate');
        winRateElement.style.color = metrics.win_rate >= 70 ? 'var(--accent-green)' : 
                                   metrics.win_rate >= 50 ? 'var(--accent-blue)' : 'var(--accent-red)';
        
        const sharpeElement = document.getElementById('sharpeRatio');
        sharpeElement.style.color = metrics.sharpe_ratio >= 1.5 ? 'var(--accent-green)' : 
                                   metrics.sharpe_ratio >= 1 ? 'var(--accent-blue)' : 'var(--accent-red)';
    }
    
    updateSystemStatus(type, message) {
        const container = document.getElementById('systemStatus');
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'warning' ? 'alert-warning' : 'alert-error';
        const icon = type === 'success' ? 'check-circle' : 
                    type === 'warning' ? 'exclamation-triangle' : 'x-circle';
        
        container.innerHTML = `
            <div class="unified-alert ${alertClass}">
                <i class="bi bi-${icon}"></i>
                <span>${message}</span>
            </div>
        `;
    }
    
    startAutoRefresh() {
        if (this.intervalId) {
            clearInterval(this.intervalId);
        }
        
        this.intervalId = setInterval(() => {
            console.log('ðŸ”„ Auto-refreshing dashboard data...');
            this.loadAllData();
        }, this.refreshInterval);
    }
    
    stopAutoRefresh() {
        if (this.intervalId) {
            clearInterval(this.intervalId);
            this.intervalId = null;
        }
    }
}

// Global functions
window.refreshPortfolio = function() {
    if (window.dashboardManager) {
        window.dashboardManager.loadAllData();
    }
};

// Initialize page
function initializePage() {
    console.log('ðŸŽ¯ Dashboard page initializing...');
    
    // Create dashboard manager
    window.dashboardManager = new DashboardDataManager();
    window.dashboardManager.init();
    
    // Add listeners for real-time updates
    document.addEventListener('portfolioUpdate', (event) => {
        if (window.dashboardManager) {
            window.dashboardManager.updatePortfolio(event.detail);
        }
    });
    
    console.log('âœ… Dashboard page initialized');
}

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (window.dashboardManager) {
        window.dashboardManager.stopAutoRefresh();
    }
});
</script>
{% endblock %}