<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard - Live Execution</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151a3a;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --accent-green: #00ff88;
            --accent-red: #ff3860;
            --accent-yellow: #ffdd57;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow-x: hidden;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(21, 26, 58, 0.8) 100%);
            border-bottom: 1px solid rgba(136, 146, 176, 0.1);
            padding: 1rem 0;
            backdrop-filter: blur(10px);
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid rgba(136, 146, 176, 0.1);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .metric-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(21, 26, 58, 0.6) 100%);
            border: 1px solid rgba(136, 146, 176, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-green);
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Bot Control Panel */
        .bot-control-panel {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f1f3a 100%);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .bot-status {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.875rem;
            text-transform: uppercase;
        }

        .bot-status.running {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }

        .bot-status.stopped {
            background: rgba(255, 56, 96, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        .bot-status.loading {
            background: rgba(255, 221, 87, 0.2);
            color: var(--accent-yellow);
            border: 1px solid var(--accent-yellow);
        }

        /* Control Buttons */
        .btn-start {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
        }

        .btn-stop {
            background: linear-gradient(135deg, #ff3860 0%, #cc2e4f 100%);
            color: #fff;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 56, 96, 0.4);
        }

        .btn-emergency {
            background: linear-gradient(135deg, #ff9500 0%, #ff6200 100%);
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: bold;
        }

        /* Positions Table */
        .positions-table {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
        }

        .positions-table thead {
            background: rgba(0, 255, 136, 0.1);
        }

        .positions-table th {
            color: var(--accent-green);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            padding: 1rem;
            border: none;
        }

        .positions-table td {
            color: var(--text-primary);
            padding: 1rem;
            border-top: 1px solid rgba(136, 146, 176, 0.1);
            vertical-align: middle;
        }

        .position-symbol {
            font-weight: bold;
            color: var(--accent-green);
            font-size: 1.1rem;
        }

        .pnl-positive {
            color: var(--accent-green);
            font-weight: bold;
        }

        .pnl-negative {
            color: var(--accent-red);
            font-weight: bold;
        }

        /* Position Action Buttons */
        .btn-position {
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 0 0.25rem;
            border: none;
        }

        .btn-edit-levels {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }

        .btn-edit-levels:hover {
            background: #3b82f6;
            color: white;
        }

        .btn-close-position {
            background: rgba(255, 56, 96, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        .btn-close-position:hover {
            background: var(--accent-red);
            color: white;
        }

        /* Risk Indicators */
        .risk-indicator {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .risk-low {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }

        .risk-medium {
            background: rgba(255, 221, 87, 0.2);
            color: var(--accent-yellow);
            border: 1px solid var(--accent-yellow);
        }

        .risk-high {
            background: rgba(255, 56, 96, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        /* Portfolio Risk Progress */
        .risk-progress {
            height: 8px;
            background: rgba(136, 146, 176, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .risk-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green) 0%, var(--accent-yellow) 50%, var(--accent-red) 100%);
            transition: width 0.3s ease;
        }

        /* Warning Alerts */
        .risk-warning {
            background: linear-gradient(135deg, rgba(255, 56, 96, 0.1) 0%, rgba(255, 56, 96, 0.05) 100%);
            border: 1px solid rgba(255, 56, 96, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .risk-warning-title {
            color: var(--accent-red);
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        /* Orders Panel */
        .order-item {
            background: rgba(21, 26, 58, 0.6);
            border-left: 3px solid var(--accent-yellow);
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
        }

        .order-buy {
            border-left-color: var(--accent-green);
        }

        .order-sell {
            border-left-color: var(--accent-red);
        }

        /* Signal Cards */
        .signal-card {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 255, 136, 0.05) 100%);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .signal-strength {
            height: 8px;
            background: rgba(136, 146, 176, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .signal-strength-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-yellow) 0%, var(--accent-green) 100%);
            transition: width 0.3s ease;
        }

        /* Chart Container */
        #tradingview-chart {
            height: 500px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid rgba(136, 146, 176, 0.1);
        }

        /* Strategy Selector */
        .strategy-selector {
            background: rgba(21, 26, 58, 0.8);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .form-select {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid rgba(136, 146, 176, 0.3);
        }

        .form-select:focus {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--accent-green);
            box-shadow: 0 0 0 0.25rem rgba(0, 255, 136, 0.25);
        }

        /* Symbol Tags */
        .symbol-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 20px;
            font-size: 0.875rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .symbol-tag.active {
            background: rgba(0, 255, 136, 0.3);
            border-color: var(--accent-green);
        }

        /* Loading Spinner */
        .spinner-border {
            width: 1rem;
            height: 1rem;
            border-width: 2px;
        }

        /* Alerts */
        .trade-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2) 0%, rgba(0, 255, 136, 0.1) 100%);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
        }

        .alert-danger {
            background: linear-gradient(135deg, rgba(255, 56, 96, 0.2) 0%, rgba(255, 56, 96, 0.1) 100%);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="dashboard-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h3 mb-0">
                        <i class="bi bi-graph-up-arrow text-success"></i>
                        Trading Dashboard - Live Execution
                    </h1>
                </div>
                <div class="col-md-6 text-end">
                    <span class="badge bg-success me-2">
                        <i class="bi bi-circle-fill"></i> Market Open
                    </span>
                    <span class="text-secondary" id="currentTime"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <!-- Bot Control Panel -->
        <div class="bot-control-panel">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <h5 class="mb-3">Bot Control</h5>
                    <div class="bot-status stopped" id="botStatus">
                        <i class="bi bi-stop-circle"></i> STOPPED
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="strategy-selector">
                        <label class="form-label small">Strategy</label>
                        <select class="form-select" id="strategySelect">
                            <option value="stoch_rsi">StochRSI + EMA</option>
                            <option value="ma_crossover">MA Crossover</option>
                            <option value="momentum">Momentum</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-2">
                        <label class="form-label small">Active Symbols</label>
                        <div id="symbolTags">
                            <span class="symbol-tag active">AAPL</span>
                            <span class="symbol-tag active">SPY</span>
                            <span class="symbol-tag active">TSLA</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-end">
                    <button class="btn btn-start me-2" onclick="startBot()" id="startBtn">
                        <i class="bi bi-play-fill"></i> Start Trading
                    </button>
                    <button class="btn btn-stop me-2" onclick="stopBot()" id="stopBtn" style="display:none;">
                        <i class="bi bi-stop-fill"></i> Stop Trading
                    </button>
                    <button class="btn btn-emergency" onclick="emergencyStop()">
                        <i class="bi bi-exclamation-triangle"></i> Cancel All
                    </button>
                </div>
            </div>
            
            <!-- Trading & Position Statistics -->
            <div class="row mt-3">
                <div class="col-md-2">
                    <div class="metric-label">Active Positions</div>
                    <div class="metric-value" id="activePositions">0</div>
                </div>
                <div class="col-md-2">
                    <div class="metric-label">Portfolio P&L</div>
                    <div class="metric-value" id="portfolioPnL">$0.00</div>
                </div>
                <div class="col-md-2">
                    <div class="metric-label">Portfolio Risk</div>
                    <div class="metric-value" id="portfolioRiskMain">0%</div>
                </div>
                <div class="col-md-2">
                    <div class="metric-label">Win Rate</div>
                    <div class="metric-value" id="winRateMain">0%</div>
                </div>
                <div class="col-md-2">
                    <div class="metric-label">Bot Uptime</div>
                    <div class="metric-value" id="botUptime">--</div>
                </div>
                <div class="col-md-2">
                    <div class="metric-label">Last Signal</div>
                    <div class="text-warning small" id="lastSignal">--</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Left Column - Chart & Signals -->
            <div class="col-md-7">
                <!-- Chart -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Price Chart</h5>
                        <div id="tradingview-chart"></div>
                    </div>
                </div>

                <!-- Recent Signals -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Recent Signals</h5>
                        <div id="signalsContainer">
                            <div class="text-center text-secondary py-3">
                                No signals yet. Start the bot to begin trading.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Position Management -->
            <div class="col-md-5">
                <!-- Portfolio Overview -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-pie-chart-fill"></i> Portfolio Overview
                        </h5>
                        <div class="row">
                            <div class="col-6">
                                <div class="metric-card">
                                    <div class="metric-label">Account Value</div>
                                    <div class="metric-value" id="accountEquity">$0.00</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="metric-card">
                                    <div class="metric-label">Total P&L</div>
                                    <div class="metric-value" id="totalPnL">$0.00</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <div class="metric-card">
                                    <div class="metric-label">Portfolio Risk</div>
                                    <div class="metric-value" id="portfolioRisk">0%</div>
                                    <div class="risk-progress">
                                        <div class="risk-progress-bar" id="riskProgressBar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="metric-card">
                                    <div class="metric-label">Win Rate</div>
                                    <div class="metric-value" id="winRate">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Warnings -->
                <div id="riskWarnings"></div>

                <!-- Position Management -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-list-ul"></i> Position Management
                            <span class="badge bg-success ms-2" id="positionCount">0</span>
                            <button class="btn btn-sm btn-outline-success float-end" onclick="refreshPositions()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </h5>
                        <div class="table-responsive">
                            <table class="table table-dark positions-table mb-0">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>P&L</th>
                                        <th>Stop/Target</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="positionsTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center py-3">
                                            <i class="bi bi-hourglass-split"></i> Loading positions...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Active Orders -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            Active Orders
                            <button class="btn btn-sm btn-outline-warning float-end" onclick="refreshOrders()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </h5>
                        <div id="ordersContainer">
                            <div class="text-center text-secondary py-3">
                                No active orders
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Alert Template -->
    <div id="tradeAlerts"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    
    <script>
        // Global variables
        let socket = null;
        let chart = null;
        let candlestickSeries = null;
        let botRunning = false;
        let refreshInterval = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            initializeChart();
            loadAccountData();
            loadPositions();
            loadOrders();
            startClock();
            
            // Auto-refresh when bot is running
            refreshInterval = setInterval(() => {
                if (botRunning) {
                    loadPositions();
                    loadOrders();
                    checkBotStatus();
                } else {
                    // Still refresh positions even when bot is stopped
                    loadPositions();
                }
            }, 5000);
        });

        // WebSocket connection
        function initializeWebSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('‚úÖ Connected to trading server');
                showAlert('Connected to trading server', 'success');
            });
            
            socket.on('disconnect', function() {
                console.log('‚ùå Disconnected from server');
                showAlert('Disconnected from server', 'danger');
            });
            
            socket.on('bot_status', function(data) {
                console.log('ü§ñ Bot status update:', data);
                updateBotUI(data.status);
            });
            
            socket.on('trade_executed', function(data) {
                console.log('üí∞ Trade executed:', data);
                showAlert(`Trade Executed: ${data.action} ${data.symbol}`, 'success');
                addSignalCard(data);
                loadPositions();
                loadOrders();
            });
            
            socket.on('price_update', function(data) {
                // Update chart with new price
                if (candlestickSeries && data.symbol === 'AAPL') {
                    updateChart(data);
                }
            });
        }

        // Initialize TradingView chart
        function initializeChart() {
            const chartContainer = document.getElementById('tradingview-chart');
            
            chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.offsetWidth,
                height: 500,
                layout: {
                    background: { color: '#0a0e27' },
                    textColor: '#8892b0',
                },
                grid: {
                    vertLines: { color: 'rgba(136, 146, 176, 0.1)' },
                    horzLines: { color: 'rgba(136, 146, 176, 0.1)' },
                },
                timeScale: {
                    borderColor: 'rgba(136, 146, 176, 0.3)',
                },
                rightPriceScale: {
                    borderColor: 'rgba(136, 146, 176, 0.3)',
                },
            });
            
            candlestickSeries = chart.addCandlestickSeries({
                upColor: '#00ff88',
                downColor: '#ff3860',
                borderVisible: false,
                wickUpColor: '#00ff88',
                wickDownColor: '#ff3860',
            });
            
            // Load initial chart data
            loadChartData();
        }

        // Bot Control Functions
        async function startBot() {
            const strategy = document.getElementById('strategySelect').value;
            const symbols = ['AAPL', 'SPY', 'TSLA']; // Get from UI
            
            try {
                const response = await fetch('/api/bot/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        strategy: strategy,
                        symbols: symbols
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    botRunning = true;
                    updateBotUI('running');
                    showAlert('Trading bot started successfully', 'success');
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline-block';
                } else {
                    showAlert('Failed to start bot: ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('Error starting bot:', error);
                showAlert('Error starting bot', 'danger');
            }
        }

        async function stopBot() {
            try {
                const response = await fetch('/api/bot/stop', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    botRunning = false;
                    updateBotUI('stopped');
                    showAlert('Trading bot stopped', 'warning');
                    document.getElementById('startBtn').style.display = 'inline-block';
                    document.getElementById('stopBtn').style.display = 'none';
                } else {
                    showAlert('Failed to stop bot: ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('Error stopping bot:', error);
                showAlert('Error stopping bot', 'danger');
            }
        }

        async function emergencyStop() {
            if (confirm('Cancel all orders and stop trading?')) {
                try {
                    await fetch('/api/orders/cancel_all', { method: 'POST' });
                    await stopBot();
                    showAlert('Emergency stop executed - All orders cancelled', 'warning');
                } catch (error) {
                    console.error('Emergency stop error:', error);
                    showAlert('Emergency stop failed', 'danger');
                }
            }
        }

        // Update bot UI status
        function updateBotUI(status) {
            const statusElement = document.getElementById('botStatus');
            
            if (status === 'running') {
                statusElement.className = 'bot-status running';
                statusElement.innerHTML = '<i class="bi bi-play-circle"></i> RUNNING';
            } else if (status === 'stopped') {
                statusElement.className = 'bot-status stopped';
                statusElement.innerHTML = '<i class="bi bi-stop-circle"></i> STOPPED';
            } else {
                statusElement.className = 'bot-status loading';
                statusElement.innerHTML = '<i class="bi bi-hourglass"></i> LOADING';
            }
        }

        // Check bot status and update position metrics
        async function checkBotStatus() {
            try {
                const response = await fetch('/api/bot/status');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('botUptime').textContent = data.uptime || '--';
                    
                    if (data.positions) {
                        document.getElementById('activePositions').textContent = data.positions.total_positions || 0;
                        
                        // Update portfolio P&L with color coding
                        const portfolioPnL = data.positions.total_pnl || 0;
                        const pnlElement = document.getElementById('portfolioPnL');
                        pnlElement.textContent = formatCurrency(portfolioPnL);
                        pnlElement.className = `metric-value ${portfolioPnL >= 0 ? '' : 'negative'}`;
                    }
                    
                    if (data.signal_stats) {
                        const winRate = data.signal_stats.execution_rate || 0;
                        document.getElementById('winRateMain').textContent = winRate.toFixed(1) + '%';
                    }
                    
                    if (data.last_signal) {
                        document.getElementById('lastSignal').textContent = 
                            `${data.last_signal.symbol} ${data.last_signal.action}`;
                    }
                }
            } catch (error) {
                console.error('Error checking bot status:', error);
            }
        }
        
        // Update main dashboard risk metrics
        function updateMainDashboardMetrics(riskData) {
            if (riskData && riskData.risk_metrics) {
                const riskPct = riskData.risk_metrics.portfolio_risk_pct || 0;
                const riskElement = document.getElementById('portfolioRiskMain');
                riskElement.textContent = `${riskPct.toFixed(1)}%`;
                riskElement.className = `metric-value ${riskPct > 80 ? 'negative' : riskPct > 60 ? 'warning' : ''}`;
            }
        }

        // Load account data
        async function loadAccountData() {
            try {
                const response = await fetch('/api/account');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('accountEquity').textContent = formatCurrency(data.balance);
                    document.getElementById('buyingPower').textContent = formatCurrency(data.buying_power);
                }
            } catch (error) {
                console.error('Error loading account:', error);
            }
        }

        // Load positions
        async function loadPositions() {
            try {
                const response = await fetch('/api/positions/summary');
                const data = await response.json();
                
                if (data.success) {
                    updatePositionsTable(data.positions || []);
                    updatePortfolioMetrics(data);
                    
                    // Load risk metrics
                    loadRiskMetrics();
                }
            } catch (error) {
                console.error('Error loading positions:', error);
            }
        }
        
        // Update positions table with enhanced display
        function updatePositionsTable(positions) {
            const tbody = document.getElementById('positionsTableBody');
            const positionCount = document.getElementById('positionCount');
            
            positionCount.textContent = positions.length;
            
            if (positions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-3">
                            <i class="bi bi-inbox"></i> No open positions
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = positions.map(pos => {
                const riskLevel = getRiskLevel(pos.risk_reward_ratio || 0);
                const stopLoss = pos.stop_loss ? `$${pos.stop_loss.toFixed(2)}` : '--';
                const takeProfit = pos.take_profit ? `$${pos.take_profit.toFixed(2)}` : '--';
                
                return `
                    <tr>
                        <td>
                            <div class="position-symbol">${pos.symbol}</div>
                            <small class="text-secondary">${pos.qty} shares @ $${pos.entry_price.toFixed(2)}</small>
                        </td>
                        <td>
                            <div class="${pos.unrealized_pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                ${formatCurrency(pos.unrealized_pnl)}
                            </div>
                            <small class="text-secondary">(${pos.unrealized_pnl_pct.toFixed(2)}%)</small>
                        </td>
                        <td>
                            <div class="small">
                                <div>SL: ${stopLoss}</div>
                                <div>TP: ${takeProfit}</div>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-position btn-edit-levels" 
                                    onclick="editPositionLevels('${pos.symbol}', ${pos.stop_loss || 0}, ${pos.take_profit || 0})" 
                                    title="Edit Stop Loss / Take Profit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-position btn-close-position" 
                                    onclick="closePosition('${pos.symbol}')" 
                                    title="Close Position">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Update portfolio metrics
        function updatePortfolioMetrics(data) {
            document.getElementById('accountEquity').textContent = formatCurrency(data.total_value || 0);
            
            const totalPnL = data.total_pnl || 0;
            const pnlElement = document.getElementById('totalPnL');
            pnlElement.textContent = formatCurrency(totalPnL);
            pnlElement.className = `metric-value ${totalPnL >= 0 ? '' : 'negative'}`;
            
            document.getElementById('winRate').textContent = `${(data.win_rate || 0).toFixed(1)}%`;
        }
        
        // Load risk metrics
        async function loadRiskMetrics() {
            try {
                const response = await fetch('/api/positions/metrics');
                const data = await response.json();
                
                if (data.success) {
                    updateRiskMetrics(data);
                    updateRiskWarnings(data.risk_metrics);
                    updateMainDashboardMetrics(data);
                }
            } catch (error) {
                console.error('Error loading risk metrics:', error);
            }
        }
        
        // Update risk metrics display
        function updateRiskMetrics(data) {
            const riskMetrics = data.risk_metrics || {};
            const riskPct = riskMetrics.portfolio_risk_pct || 0;
            
            const riskElement = document.getElementById('portfolioRisk');
            riskElement.textContent = `${riskPct.toFixed(1)}%`;
            riskElement.className = `metric-value ${riskPct > 80 ? 'negative' : riskPct > 60 ? 'warning' : ''}`;
            
            // Update risk progress bar
            const progressBar = document.getElementById('riskProgressBar');
            progressBar.style.width = `${Math.min(riskPct, 100)}%`;
        }
        
        // Update risk warnings
        function updateRiskWarnings(riskMetrics) {
            const container = document.getElementById('riskWarnings');
            const warnings = riskMetrics?.risk_warnings || [];
            
            if (warnings.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = warnings.map(warning => `
                <div class="risk-warning">
                    <div class="risk-warning-title">
                        <i class="bi bi-exclamation-triangle"></i> Risk Alert
                    </div>
                    <div>${warning}</div>
                </div>
            `).join('');
        }
        
        function refreshPositions() {
            loadPositions();
            showAlert('Positions refreshed', 'info');
        }
        
        // Edit position levels (stop loss / take profit)
        async function editPositionLevels(symbol, currentStopLoss, currentTakeProfit) {
            const stopLoss = prompt(`Enter new Stop Loss for ${symbol}:`, currentStopLoss || '');
            const takeProfit = prompt(`Enter new Take Profit for ${symbol}:`, currentTakeProfit || '');
            
            if (stopLoss === null && takeProfit === null) return;
            
            try {
                const response = await fetch(`/api/positions/${symbol}/levels`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        stop_loss: stopLoss ? parseFloat(stopLoss) : null,
                        take_profit: takeProfit ? parseFloat(takeProfit) : null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`Updated levels for ${symbol}`, 'success');
                    loadPositions();
                } else {
                    showAlert(`Failed to update levels for ${symbol}`, 'danger');
                }
            } catch (error) {
                console.error('Error updating position levels:', error);
                showAlert('Error updating position levels', 'danger');
            }
        }
        
        // Close position
        async function closePosition(symbol) {
            if (!confirm(`Are you sure you want to close the position for ${symbol}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/positions/${symbol}/close`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reason: 'manual_close'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`Position closed for ${symbol}`, 'success');
                    loadPositions();
                    loadOrders(); // Refresh orders as well
                } else {
                    showAlert(`Failed to close position for ${symbol}`, 'danger');
                }
            } catch (error) {
                console.error('Error closing position:', error);
                showAlert('Error closing position', 'danger');
            }
        }
        
        // Get risk level indicator
        function getRiskLevel(ratio) {
            if (!ratio || ratio === 0) return 'risk-medium';
            if (ratio >= 2) return 'risk-low';
            if (ratio >= 1) return 'risk-medium';
            return 'risk-high';
        }

        // Load active orders
        async function loadOrders() {
            try {
                const response = await fetch('/api/orders/active');
                const data = await response.json();
                
                if (data.success && data.orders && data.orders.length > 0) {
                    const container = document.getElementById('ordersContainer');
                    container.innerHTML = data.orders.map(order => `
                        <div class="order-item ${order.side === 'buy' ? 'order-buy' : 'order-sell'}">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>${order.symbol}</strong>
                                    <span class="badge bg-secondary ms-2">${order.type.toUpperCase()}</span>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder('${order.id}')">
                                    Cancel
                                </button>
                            </div>
                            <div class="small text-secondary mt-1">
                                ${order.side.toUpperCase()} ${order.qty} shares
                                ${order.limit_price ? `@ $${order.limit_price}` : ''}
                                ${order.stop_price ? `Stop: $${order.stop_price}` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('ordersContainer').innerHTML = 
                        '<div class="text-center text-secondary py-3">No active orders</div>';
                }
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }
        
        function refreshOrders() {
            loadOrders();
            showAlert('Orders refreshed', 'info');
        }

        // Cancel order
        async function cancelOrder(orderId) {
            try {
                const response = await fetch(`/api/orders/cancel/${orderId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Order cancelled', 'warning');
                    loadOrders();
                } else {
                    showAlert('Failed to cancel order', 'danger');
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                showAlert('Error cancelling order', 'danger');
            }
        }

        // Load chart data
        async function loadChartData() {
            try {
                const response = await fetch('/api/v2/chart-data/AAPL?timeframe=15Min&limit=100');
                const data = await response.json();
                
                if (data.success && data.candlestick_data) {
                    const chartData = data.candlestick_data.map(candle => ({
                        time: new Date(candle.timestamp).getTime() / 1000,
                        open: candle.open,
                        high: candle.high,
                        low: candle.low,
                        close: candle.close
                    }));
                    
                    candlestickSeries.setData(chartData);
                }
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }

        // Update chart with new data
        function updateChart(priceData) {
            if (candlestickSeries) {
                candlestickSeries.update({
                    time: new Date().getTime() / 1000,
                    open: priceData.price,
                    high: priceData.price,
                    low: priceData.price,
                    close: priceData.price
                });
            }
        }

        // Add signal card
        function addSignalCard(signal) {
            const container = document.getElementById('signalsContainer');
            const signalHtml = `
                <div class="signal-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${signal.symbol}</strong>
                            <span class="badge ${signal.action === 'BUY' ? 'bg-success' : 'bg-danger'} ms-2">
                                ${signal.action}
                            </span>
                        </div>
                        <small class="text-secondary">${new Date().toLocaleTimeString()}</small>
                    </div>
                    <div class="signal-strength">
                        <div class="signal-strength-bar" style="width: ${signal.strength || 75}%"></div>
                    </div>
                </div>
            `;
            
            // Remove placeholder if exists
            if (container.innerHTML.includes('No signals yet')) {
                container.innerHTML = '';
            }
            
            // Add new signal at top
            container.insertAdjacentHTML('afterbegin', signalHtml);
            
            // Keep only last 5 signals
            const signals = container.querySelectorAll('.signal-card');
            if (signals.length > 5) {
                signals[signals.length - 1].remove();
            }
        }

        // Show alert
        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} trade-alert alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const alertContainer = document.getElementById('tradeAlerts');
            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }

        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(value);
        }

        // Start clock
        function startClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('currentTime').textContent = now.toLocaleTimeString();
            }, 1000);
        }
    </script>
</body>
</html>