<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpaca Trading Bot - Real-time Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        .real-time-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .streaming-active { background-color: #28a745; animation: pulse 2s infinite; }
        .streaming-inactive { background-color: #dc3545; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .ticker-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .ticker-up { border-left-color: #28a745; background-color: rgba(40, 167, 69, 0.1); }
        .ticker-down { border-left-color: #dc3545; background-color: rgba(220, 53, 69, 0.1); }
        .price-change-up { color: #28a745; }
        .price-change-down { color: #dc3545; }
        .chart-container { height: 400px; }
        .position-positive { background-color: rgba(40, 167, 69, 0.1); border-left: 4px solid #28a745; }
        .position-negative { background-color: rgba(220, 53, 69, 0.1); border-left: 4px solid #dc3545; }
        .last-update { font-size: 0.8em; color: #6c757d; }
        .metric-card { border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Signal Dashboard Styles */
        .signal-card { border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .signal-active { border-left: 4px solid #28a745; background-color: rgba(40, 167, 69, 0.1); }
        .signal-inactive { border-left: 4px solid #6c757d; background-color: rgba(108, 117, 125, 0.1); }
        .signal-oversold { border-left: 4px solid #ffc107; background-color: rgba(255, 193, 7, 0.1); }
        .signal-strength-bar { width: 100%; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden; }
        .signal-strength-fill { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .indicator-value { font-family: 'Courier New', monospace; font-weight: bold; }
        .threshold-line { border-top: 2px dashed #dc3545; position: relative; margin: 10px 0; }
        .threshold-label { position: absolute; right: 0; top: -12px; font-size: 0.75em; color: #dc3545; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-graph-up"></i> Alpaca Trading Bot Dashboard
            </span>
            <div class="d-flex align-items-center">
                <span class="real-time-indicator streaming-inactive" id="streamingIndicator"></span>
                <span class="text-light me-3" id="streamingStatus">Disconnected</span>
                <span class="text-light last-update" id="lastUpdate">Never</span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- Control Panel -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-gear"></i> Control Panel</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>Bot Control</h6>
                                <button class="btn btn-success me-2" id="startBotBtn">
                                    <i class="bi bi-play"></i> Start Bot
                                </button>
                                <button class="btn btn-danger me-2" id="stopBotBtn">
                                    <i class="bi bi-stop"></i> Stop Bot
                                </button>
                                <span class="badge bg-secondary" id="botStatus">Unknown</span>
                            </div>
                            <div class="col-md-4">
                                <h6>Real-time Streaming</h6>
                                <button class="btn btn-primary me-2" id="startStreamBtn">
                                    <i class="bi bi-broadcast"></i> Start Stream
                                </button>
                                <button class="btn btn-secondary me-2" id="stopStreamBtn">
                                    <i class="bi bi-stop-circle"></i> Stop Stream
                                </button>
                                <div class="mt-2">
                                    <label for="refreshInterval" class="form-label">Interval (seconds):</label>
                                    <input type="range" class="form-range" id="refreshInterval" min="1" max="30" value="5">
                                    <span id="intervalValue">5</span>s
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>Ticker Management</h6>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="newTicker" placeholder="e.g., AAPL">
                                    <button class="btn btn-outline-primary" id="addTickerBtn">Add</button>
                                </div>
                                <div id="tickerList" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Overview -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-wallet2"></i> Account Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="accountMetrics">
                            <div class="col-lg-2 col-md-4 mb-3">
                                <div class="card metric-card text-center">
                                    <div class="card-body">
                                        <h6 class="card-title">Portfolio Value</h6>
                                        <h4 class="text-primary" id="portfolioValue">$0.00</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 mb-3">
                                <div class="card metric-card text-center">
                                    <div class="card-body">
                                        <h6 class="card-title">Cash</h6>
                                        <h4 class="text-info" id="cashBalance">$0.00</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 mb-3">
                                <div class="card metric-card text-center">
                                    <div class="card-body">
                                        <h6 class="card-title">Buying Power</h6>
                                        <h4 class="text-warning" id="buyingPower">$0.00</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 mb-3">
                                <div class="card metric-card text-center">
                                    <div class="card-body">
                                        <h6 class="card-title">Day P/L</h6>
                                        <h4 id="dayPL">$0.00</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 mb-3">
                                <div class="card metric-card text-center">
                                    <div class="card-body">
                                        <h6 class="card-title">Equity</h6>
                                        <h4 class="text-success" id="equity">$0.00</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Tickers -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-graph-up-arrow"></i> Live Prices</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="tickerPrices">
                            <div class="col-12 text-center text-muted">
                                No tickers configured. Add tickers to see live prices.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Trading Signals -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-cpu"></i> Live Trading Signals</h5>
                        <small class="text-muted">Real-time technical indicator signals and strategy logic</small>
                    </div>
                    <div class="card-body">
                        <div id="signalsDashboard">
                            <div class="text-center text-muted">
                                Start streaming to see live trading signals...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Positions -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-briefcase"></i> Live Positions</h5>
                    </div>
                    <div class="card-body">
                        <div id="positionsList">
                            <div class="text-center text-muted">
                                No positions available.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-bar-chart"></i> Price Chart</h5>
                        <select class="form-select w-auto" id="chartTicker">
                            <option value="">Select Ticker</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="priceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let socket;
        let priceChart;
        let isStreaming = false;
        let currentTickers = [];
        let currentPrices = {};

        // Initialize socket connection
        function initSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
                updateStreamingStatus('Connected', true);
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from server');
                updateStreamingStatus('Disconnected', false);
            });
            
            socket.on('real_time_update', function(data) {
                console.log('Received real-time update:', data); // Debug log
                console.log('ticker_prices:', data.ticker_prices);
                console.log('ticker_signals:', data.ticker_signals);
                console.log('positions:', data.positions);
                updateLastUpdateTime();
                if (data.account_info) {
                    updateAccountInfo(data.account_info);
                }
                if (data.positions) {
                    updatePositions(data.positions);
                }
                if (data.ticker_prices) {
                    updateTickerPrices(data.ticker_prices);
                }
                if (data.ticker_signals) {
                    updateTradingSignals(data.ticker_signals);
                }
                if (data.bot_running !== undefined) {
                    updateBotStatus(data.bot_running);
                }
            });
            
            socket.on('streaming_status', function(data) {
                isStreaming = data.active;
                updateStreamingControls();
            });
        }

        // Update streaming status indicator
        function updateStreamingStatus(status, connected) {
            const indicator = document.getElementById('streamingIndicator');
            const statusText = document.getElementById('streamingStatus');
            
            if (connected && isStreaming) {
                indicator.className = 'real-time-indicator streaming-active';
                statusText.textContent = 'Streaming Live';
            } else if (connected) {
                indicator.className = 'real-time-indicator streaming-inactive';
                statusText.textContent = 'Connected';
            } else {
                indicator.className = 'real-time-indicator streaming-inactive';
                statusText.textContent = status;
            }
        }

        // Update last update time
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }

        // Update account information
        function updateAccountInfo(account) {
            if (!account) return;
            
            document.getElementById('portfolioValue').textContent = `$${account.portfolio_value.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('cashBalance').textContent = `$${account.cash.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('buyingPower').textContent = `$${account.buying_power.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('equity').textContent = `$${account.equity.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            
            const dayPLElement = document.getElementById('dayPL');
            const dayPL = account.day_pl;
            dayPLElement.textContent = `${dayPL >= 0 ? '+' : ''}$${Math.abs(dayPL).toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            dayPLElement.className = dayPL >= 0 ? 'text-success' : 'text-danger';
        }

        // Update positions
        function updatePositions(positions) {
            const container = document.getElementById('positionsList');
            
            if (!positions || positions.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No positions available.</div>';
                return;
            }
            
            let html = '<div class="row">';
            positions.forEach(pos => {
                const isPositive = pos.unrealized_pl >= 0;
                const cardClass = isPositive ? 'position-positive' : 'position-negative';
                const plColor = isPositive ? 'text-success' : 'text-danger';
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card ${cardClass}">
                            <div class="card-body">
                                <h6 class="card-title">${pos.symbol}</h6>
                                <p class="card-text">
                                    <strong>Qty:</strong> ${pos.qty}<br>
                                    <strong>Avg Entry:</strong> $${pos.avg_entry_price.toFixed(2)}<br>
                                    <strong>Current:</strong> $${pos.current_price.toFixed(2)}<br>
                                    <strong>Market Value:</strong> $${pos.market_value.toLocaleString('en-US', {minimumFractionDigits: 2})}
                                </p>
                                <div class="${plColor}">
                                    <strong>P/L:</strong> ${isPositive ? '+' : ''}$${Math.abs(pos.unrealized_pl).toFixed(2)} (${pos.unrealized_plpc.toFixed(2)}%)
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Update ticker prices
        function updateTickerPrices(prices) {
            console.log('updateTickerPrices called with:', prices); // Debug
            const container = document.getElementById('tickerPrices');
            
            if (!prices || Object.keys(prices).length === 0) {
                console.log('No prices data received'); // Debug
                if (isStreaming) {
                    container.innerHTML = '<div class="col-12 text-center text-muted">Fetching live prices...</div>';
                } else {
                    container.innerHTML = '<div class="col-12 text-center text-muted">Start streaming to see live prices...</div>';
                }
                return;
            }
            
            console.log('Rendering prices for', Object.keys(prices).length, 'tickers'); // Debug
            
            let html = '';
            Object.entries(prices).forEach(([ticker, price]) => {
                const prevPrice = currentPrices[ticker] || price;
                const isUp = price > prevPrice;
                const cardClass = isUp ? 'ticker-up' : (price < prevPrice ? 'ticker-down' : '');
                const priceChangeClass = isUp ? 'price-change-up' : (price < prevPrice ? 'price-change-down' : '');
                
                html += `
                    <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-3">
                        <div class="card ticker-card ${cardClass}">
                            <div class="card-body text-center">
                                <h6 class="card-title">${ticker}</h6>
                                <h5 class="${priceChangeClass}">$${price.toFixed(4)}</h5>
                                <small class="text-muted">
                                    ${isUp ? '↑' : (price < prevPrice ? '↓' : '→')}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Update currentPrices after rendering
            currentPrices = {...prices};
            container.innerHTML = html;
        }

        // Update trading signals
        function updateTradingSignals(tickerSignals) {
            const container = document.getElementById('signalsDashboard');
            
            console.log('Updating trading signals:', tickerSignals); // Debug log
            
            if (!tickerSignals || Object.keys(tickerSignals).length === 0) {
                if (isStreaming) {
                    container.innerHTML = '<div class="text-center text-muted">Calculating signals...</div>';
                } else {
                    container.innerHTML = '<div class="text-center text-muted">Start streaming to see live trading signals...</div>';
                }
                return;
            }
            
            let html = '<div class="row">';
            
            Object.entries(tickerSignals).forEach(([ticker, signals]) => {
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card signal-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${ticker} Signals</h6>
                                <span class="badge ${getOverallSignalBadge(signals)}">
                                    ${getOverallSignalStatus(signals)}
                                </span>
                            </div>
                            <div class="card-body">
                `;
                
                // StochRSI Indicator (currently active strategy)
                if (signals.stochRSI) {
                    const stochRSI = signals.stochRSI;
                    const signalClass = stochRSI.signal === 1 ? 'signal-active' : 
                                       stochRSI.status === 'OVERSOLD' ? 'signal-oversold' : 'signal-inactive';
                    
                    html += `
                        <div class="mb-3 p-2 ${signalClass}" style="border-radius: 6px;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>StochRSI</strong>
                                <span class="badge ${stochRSI.signal === 1 ? 'bg-success' : 'bg-secondary'}">
                                    ${stochRSI.signal === 1 ? 'BUY' : 'WAIT'}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>K: <span class="indicator-value">${stochRSI.k.toFixed(2)}</span></span>
                                <span>D: <span class="indicator-value">${stochRSI.d.toFixed(2)}</span></span>
                            </div>
                            <div class="threshold-line">
                                <div class="threshold-label">Threshold: ${stochRSI.lower_band}</div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">Status: ${stochRSI.status}</small>
                                <div class="signal-strength-bar mt-1">
                                    <div class="signal-strength-fill bg-${stochRSI.signal === 1 ? 'success' : 'warning'}" 
                                         style="width: ${Math.min(stochRSI.strength * 100, 100)}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Stochastic Indicator (if enabled)
                if (signals.stoch) {
                    const stoch = signals.stoch;
                    html += `
                        <div class="mb-3 p-2 ${stoch.signal === 1 ? 'signal-active' : 'signal-inactive'}" style="border-radius: 6px;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Stochastic</strong>
                                <span class="badge ${stoch.signal === 1 ? 'bg-success' : 'bg-secondary'}">
                                    ${stoch.signal === 1 ? 'BUY' : 'WAIT'}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>K: <span class="indicator-value">${stoch.k.toFixed(2)}</span></span>
                                <span>D: <span class="indicator-value">${stoch.d.toFixed(2)}</span></span>
                            </div>
                            <small class="text-muted">Status: ${stoch.status}</small>
                        </div>
                    `;
                }
                
                // EMA Indicator (if enabled)
                if (signals.ema) {
                    const ema = signals.ema;
                    html += `
                        <div class="mb-2 p-2 ${ema.signal === 1 ? 'signal-active' : 'signal-inactive'}" style="border-radius: 6px;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>EMA</strong>
                                <span class="badge ${ema.signal === 1 ? 'bg-success' : 'bg-secondary'}">
                                    ${ema.signal === 1 ? 'BUY' : 'WAIT'}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>EMA: <span class="indicator-value">${ema.value.toFixed(4)}</span></span>
                                <span class="text-muted">${ema.status}</span>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Helper functions for signal dashboard
        function getOverallSignalStatus(signals) {
            if (signals.stochRSI && signals.stochRSI.signal === 1) return 'BUY SIGNAL';
            if (signals.stochRSI && signals.stochRSI.status === 'OVERSOLD') return 'OVERSOLD';
            return 'MONITORING';
        }
        
        function getOverallSignalBadge(signals) {
            if (signals.stochRSI && signals.stochRSI.signal === 1) return 'bg-success';
            if (signals.stochRSI && signals.stochRSI.status === 'OVERSOLD') return 'bg-warning';
            return 'bg-secondary';
        }

        // Update bot status
        function updateBotStatus(isRunning) {
            const statusBadge = document.getElementById('botStatus');
            const startBtn = document.getElementById('startBotBtn');
            const stopBtn = document.getElementById('stopBotBtn');
            
            if (isRunning) {
                statusBadge.textContent = 'Running';
                statusBadge.className = 'badge bg-success';
                startBtn.disabled = true;
                stopBtn.disabled = false;
            } else {
                statusBadge.textContent = 'Stopped';
                statusBadge.className = 'badge bg-danger';
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        }

        // Update streaming controls
        function updateStreamingControls() {
            const startBtn = document.getElementById('startStreamBtn');
            const stopBtn = document.getElementById('stopStreamBtn');
            
            startBtn.disabled = isStreaming;
            stopBtn.disabled = !isStreaming;
            
            updateStreamingStatus(isStreaming ? 'Streaming Live' : 'Connected', true);
        }

        // Load tickers
        function loadTickers() {
            console.log('Loading tickers...'); // Debug
            fetch('/api/tickers')
                .then(response => response.json())
                .then(data => {
                    console.log('Tickers API response:', data); // Debug
                    if (data.success) {
                        currentTickers = data.tickers;
                        console.log('Set currentTickers to:', currentTickers); // Debug
                        updateTickerList();
                        updateChartTickerOptions();
                        // Force update ticker prices display immediately
                        const container = document.getElementById('tickerPrices');
                        if (currentTickers.length > 0) {
                            container.innerHTML = '<div class="col-12 text-center text-muted">Tickers loaded. Start streaming to see prices...</div>';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading tickers:', error);
                });
        }

        // Update ticker list display
        function updateTickerList() {
            const container = document.getElementById('tickerList');
            let html = '';
            
            currentTickers.forEach(ticker => {
                html += `
                    <span class="badge bg-primary me-2 mb-1">
                        ${ticker}
                        <button type="button" class="btn-close btn-close-white ms-1" onclick="removeTicker('${ticker}')"></button>
                    </span>
                `;
            });
            
            container.innerHTML = html;
        }

        // Update chart ticker options
        function updateChartTickerOptions() {
            const select = document.getElementById('chartTicker');
            select.innerHTML = '<option value="">Select Ticker</option>';
            
            currentTickers.forEach(ticker => {
                select.innerHTML += `<option value="${ticker}">${ticker}</option>`;
            });
        }

        // Add ticker
        function addTicker() {
            const input = document.getElementById('newTicker');
            const ticker = input.value.trim().toUpperCase();
            
            if (ticker) {
                fetch('/api/tickers', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ticker: ticker})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        input.value = '';
                        loadTickers();
                    }
                });
            }
        }

        // Remove ticker
        function removeTicker(ticker) {
            fetch('/api/tickers', {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ticker: ticker})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadTickers();
                }
            });
        }

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Price',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // Load chart data
        function loadChartData(ticker) {
            if (!ticker) return;
            
            fetch(`/api/chart/${ticker}?timeframe=1Min&limit=50`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        priceChart.data.labels = data.data.timestamps;
                        priceChart.data.datasets[0].data = data.data.close;
                        priceChart.data.datasets[0].label = `${ticker} Price`;
                        priceChart.update();
                    }
                });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initSocket();
            initChart();
            loadTickers();
            
            // Bot controls
            document.getElementById('startBotBtn').addEventListener('click', function() {
                fetch('/api/bot/start', {method: 'POST'})
                    .then(response => response.json())
                    .then(data => console.log('Bot start response:', data));
            });
            
            document.getElementById('stopBotBtn').addEventListener('click', function() {
                fetch('/api/bot/stop', {method: 'POST'})
                    .then(response => response.json())
                    .then(data => console.log('Bot stop response:', data));
            });
            
            // Streaming controls
            document.getElementById('startStreamBtn').addEventListener('click', function() {
                const interval = parseInt(document.getElementById('refreshInterval').value);
                socket.emit('start_streaming', {interval: interval});
                isStreaming = true;
                updateStreamingControls();
            });
            
            document.getElementById('stopStreamBtn').addEventListener('click', function() {
                socket.emit('stop_streaming');
                isStreaming = false;
                updateStreamingControls();
            });
            
            // Interval slider
            document.getElementById('refreshInterval').addEventListener('input', function() {
                const value = this.value;
                document.getElementById('intervalValue').textContent = value;
                if (isStreaming) {
                    socket.emit('update_interval', {interval: parseInt(value)});
                }
            });
            
            // Ticker management
            document.getElementById('addTickerBtn').addEventListener('click', addTicker);
            document.getElementById('newTicker').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addTicker();
            });
            
            // Chart ticker selection
            document.getElementById('chartTicker').addEventListener('change', function() {
                loadChartData(this.value);
            });
        });
    </script>
</body>
</html>