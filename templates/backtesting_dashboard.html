<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic 2: Historical Data & Backtesting Dashboard</title>
    
    <!-- TradingView Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    
    <!-- Socket.IO for real-time updates -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        .dashboard-header {
            background: rgba(26, 31, 46, 0.95);
            border-bottom: 2px solid #4CAF50;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: #4CAF50;
        }
        
        .market-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-open { background: #4CAF50; }
        .status-closed { background: #FF5252; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .chart-container {
            background: rgba(26, 31, 46, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .chart-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .symbol-input {
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4CAF50;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 14px;
            width: 100px;
        }
        
        .timeframe-buttons {
            display: flex;
            gap: 5px;
        }
        
        .timeframe-btn {
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            border-radius: 6px;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .timeframe-btn:hover {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
        }
        
        .timeframe-btn.active {
            background: #4CAF50;
            color: #000;
            border-color: #4CAF50;
        }
        
        #chart {
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .data-source-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            font-size: 12px;
        }
        
        .source-live { color: #4CAF50; }
        .source-historical { color: #FFA726; }
        
        .backtest-panel {
            background: rgba(26, 31, 46, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #4CAF50;
        }
        
        .backtest-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .date-range {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .date-input {
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            border-radius: 6px;
            color: #e0e0e0;
        }
        
        .strategy-select {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            border-radius: 6px;
            color: #e0e0e0;
        }
        
        .run-backtest-btn {
            padding: 12px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .run-backtest-btn:hover {
            background: linear-gradient(135deg, #45a049, #4CAF50);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .run-backtest-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        
        .backtest-results {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .metric-label {
            color: #999;
            font-size: 14px;
        }
        
        .metric-value {
            font-weight: 600;
            font-size: 14px;
        }
        
        .metric-positive { color: #4CAF50; }
        .metric-negative { color: #FF5252; }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .performance-card {
            background: rgba(26, 31, 46, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .cache-stats {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 13px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(76, 175, 80, 0.3);
            border-top-color: #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="header-title">📊 Epic 2: Historical Data & Backtesting Dashboard</div>
        <div class="market-status">
            <div class="status-indicator" id="marketStatusIndicator"></div>
            <span id="marketStatusText">Checking...</span>
            <div class="data-source-indicator" id="dataSourceIndicator">
                <span id="dataSourceText">Loading...</span>
            </div>
        </div>
    </div>
    
    <div class="dashboard-container">
        <div class="main-content">
            <div class="chart-container">
                <div class="chart-controls">
                    <div class="control-group">
                        <input type="text" class="symbol-input" id="symbolInput" value="AAPL" placeholder="Symbol">
                        <button class="timeframe-btn" onclick="loadSymbol()">Load</button>
                    </div>
                    <div class="timeframe-buttons">
                        <button class="timeframe-btn" data-timeframe="1Min">1m</button>
                        <button class="timeframe-btn" data-timeframe="5Min">5m</button>
                        <button class="timeframe-btn active" data-timeframe="15Min">15m</button>
                        <button class="timeframe-btn" data-timeframe="1Hour">1H</button>
                        <button class="timeframe-btn" data-timeframe="1Day">1D</button>
                    </div>
                    <div class="control-group">
                        <label style="font-size: 12px;">
                            <input type="checkbox" id="autoRefresh" checked> Auto-refresh
                        </label>
                    </div>
                </div>
                <div id="chart"></div>
            </div>
            
            <div class="backtest-panel">
                <div class="panel-title">🧪 Backtesting Engine</div>
                <div class="backtest-controls">
                    <div class="date-range">
                        <label style="font-size: 12px; color: #999;">Date Range</label>
                        <input type="date" class="date-input" id="startDate">
                        <input type="date" class="date-input" id="endDate">
                    </div>
                    <select class="strategy-select" id="strategySelect">
                        <option value="stoch_rsi">StochRSI Strategy</option>
                        <option value="stoch_rsi_enhanced">Enhanced StochRSI (Epic 1)</option>
                        <option value="ma_crossover">MA Crossover</option>
                        <option value="volume_momentum">Volume Momentum</option>
                    </select>
                    <button class="run-backtest-btn" id="runBacktestBtn" onclick="runBacktest()">
                        Run Backtest
                    </button>
                </div>
                <div class="backtest-results" id="backtestResults">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        No backtest results yet. Configure parameters and click "Run Backtest".
                    </div>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="performance-card">
                <div class="panel-title">📈 Performance Metrics</div>
                <div id="performanceMetrics">
                    <div class="result-metric">
                        <span class="metric-label">Total Return</span>
                        <span class="metric-value" id="totalReturn">--</span>
                    </div>
                    <div class="result-metric">
                        <span class="metric-label">Sharpe Ratio</span>
                        <span class="metric-value" id="sharpeRatio">--</span>
                    </div>
                    <div class="result-metric">
                        <span class="metric-label">Max Drawdown</span>
                        <span class="metric-value" id="maxDrawdown">--</span>
                    </div>
                    <div class="result-metric">
                        <span class="metric-label">Win Rate</span>
                        <span class="metric-value" id="winRate">--</span>
                    </div>
                    <div class="result-metric">
                        <span class="metric-label">Profit Factor</span>
                        <span class="metric-value" id="profitFactor">--</span>
                    </div>
                </div>
            </div>
            
            <div class="performance-card">
                <div class="panel-title">💾 Data Cache Status</div>
                <div class="cache-stats">
                    <div class="stat-row">
                        <span>Cached Symbols</span>
                        <span id="cachedSymbols">0</span>
                    </div>
                    <div class="stat-row">
                        <span>Total Records</span>
                        <span id="totalRecords">0</span>
                    </div>
                    <div class="stat-row">
                        <span>Cache Size</span>
                        <span id="cacheSize">0 MB</span>
                    </div>
                    <div class="stat-row">
                        <span>Last Update</span>
                        <span id="lastUpdate">Never</span>
                    </div>
                    <div class="stat-row">
                        <span>Data Range</span>
                        <span id="dataRange">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <script>
        // Global variables
        let chart = null;
        let candlestickSeries = null;
        let volumeSeries = null;
        let currentSymbol = 'AAPL';
        let currentTimeframe = '15Min';
        let socket = null;
        let autoRefreshInterval = null;
        let isMarketOpen = false;
        let dataSource = 'historical';
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Epic 2 Dashboard Initializing...');
            initializeChart();
            initializeWebSocket();
            setupEventListeners();
            checkMarketStatus();
            loadInitialData();
            updateCacheStats();
            setDefaultDates();
        });
        
        function initializeChart() {
            const chartElement = document.getElementById('chart');
            
            chart = LightweightCharts.createChart(chartElement, {
                width: chartElement.offsetWidth,
                height: 500,
                layout: {
                    background: { type: 'solid', color: 'transparent' },
                    textColor: '#e0e0e0',
                },
                grid: {
                    vertLines: { color: 'rgba(255, 255, 255, 0.05)' },
                    horzLines: { color: 'rgba(255, 255, 255, 0.05)' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                },
                timeScale: {
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });
            
            candlestickSeries = chart.addCandlestickSeries({
                upColor: '#4CAF50',
                downColor: '#FF5252',
                borderUpColor: '#4CAF50',
                borderDownColor: '#FF5252',
                wickUpColor: '#4CAF50',
                wickDownColor: '#FF5252',
            });
            
            // Add volume series
            volumeSeries = chart.addHistogramSeries({
                color: '#26a69a',
                priceFormat: {
                    type: 'volume',
                },
                priceScaleId: '',
                scaleMargins: {
                    top: 0.8,
                    bottom: 0,
                },
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                chart.applyOptions({ width: chartElement.offsetWidth });
            });
            
            console.log('✅ Chart initialized');
        }
        
        function initializeWebSocket() {
            socket = io('http://localhost:9765');
            
            socket.on('connect', function() {
                console.log('✅ WebSocket connected');
                socket.emit('subscribe', { symbol: currentSymbol });
            });
            
            socket.on('price_update', function(data) {
                if (data.symbol === currentSymbol && isMarketOpen) {
                    updateLatestPrice(data);
                }
            });
            
            socket.on('disconnect', function() {
                console.log('❌ WebSocket disconnected');
            });
        }
        
        function setupEventListeners() {
            // Timeframe buttons
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.dataset.timeframe) {
                        document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        currentTimeframe = this.dataset.timeframe;
                        loadChartData();
                    }
                });
            });
            
            // Auto-refresh checkbox
            document.getElementById('autoRefresh').addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
            
            // Symbol input enter key
            document.getElementById('symbolInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadSymbol();
                }
            });
        }
        
        function loadSymbol() {
            const symbolInput = document.getElementById('symbolInput');
            const newSymbol = symbolInput.value.toUpperCase();
            
            if (newSymbol && newSymbol !== currentSymbol) {
                currentSymbol = newSymbol;
                socket.emit('subscribe', { symbol: currentSymbol });
                loadChartData();
                updateCacheStats();
            }
        }
        
        async function loadChartData() {
            showLoading(true);
            
            try {
                // Determine endpoint based on market status
                const endpoint = isMarketOpen ? 
                    `/api/v2/chart-data/${currentSymbol}?timeframe=${currentTimeframe}&limit=500` :
                    `/api/historical/${currentSymbol}?timeframe=${currentTimeframe}&days=30`;
                
                const response = await fetch(endpoint);
                const data = await response.json();
                
                if (data.success && (data.candlestick_data || data.historical_data)) {
                    const chartData = data.candlestick_data || data.historical_data;
                    dataSource = data.data_source || (isMarketOpen ? 'live' : 'historical');
                    
                    updateDataSourceIndicator();
                    
                    // Convert data to chart format
                    const candlesticks = chartData.map(candle => ({
                        time: new Date(candle.timestamp).getTime() / 1000,
                        open: candle.open,
                        high: candle.high,
                        low: candle.low,
                        close: candle.close,
                    }));
                    
                    const volumes = chartData.map(candle => ({
                        time: new Date(candle.timestamp).getTime() / 1000,
                        value: candle.volume,
                        color: candle.close >= candle.open ? '#4CAF50' : '#FF5252',
                    }));
                    
                    candlestickSeries.setData(candlesticks);
                    volumeSeries.setData(volumes);
                    
                    console.log(`✅ Loaded ${candlesticks.length} candles for ${currentSymbol} (${dataSource})`);
                } else {
                    console.error('Failed to load chart data:', data.error);
                }
            } catch (error) {
                console.error('Error loading chart data:', error);
            } finally {
                showLoading(false);
            }
        }
        
        async function checkMarketStatus() {
            try {
                const response = await fetch('/api/market_status');
                const data = await response.json();
                
                isMarketOpen = data.is_open;
                const statusIndicator = document.getElementById('marketStatusIndicator');
                const statusText = document.getElementById('marketStatusText');
                
                if (isMarketOpen) {
                    statusIndicator.className = 'status-indicator status-open';
                    statusText.textContent = 'Market Open';
                } else {
                    statusIndicator.className = 'status-indicator status-closed';
                    statusText.textContent = 'Market Closed';
                    
                    // Show next open time
                    if (data.next_open) {
                        const nextOpen = new Date(data.next_open);
                        const hoursUntil = Math.floor((nextOpen - new Date()) / 3600000);
                        statusText.textContent += ` (Opens in ${hoursUntil}h)`;
                    }
                }
                
                updateDataSourceIndicator();
                
                // Check again in 1 minute
                setTimeout(checkMarketStatus, 60000);
            } catch (error) {
                console.error('Error checking market status:', error);
                setTimeout(checkMarketStatus, 60000);
            }
        }
        
        function updateDataSourceIndicator() {
            const sourceText = document.getElementById('dataSourceText');
            const sourceIndicator = document.getElementById('dataSourceIndicator');
            
            if (isMarketOpen && dataSource === 'live') {
                sourceText.textContent = '🟢 Live Data';
                sourceIndicator.className = 'data-source-indicator source-live';
            } else {
                sourceText.textContent = '📊 Historical Data';
                sourceIndicator.className = 'data-source-indicator source-historical';
            }
        }
        
        async function runBacktest() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const strategy = document.getElementById('strategySelect').value;
            const runBtn = document.getElementById('runBacktestBtn');
            
            if (!startDate || !endDate) {
                alert('Please select date range for backtest');
                return;
            }
            
            runBtn.disabled = true;
            runBtn.textContent = 'Running...';
            showLoading(true);
            
            try {
                const response = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: currentSymbol,
                        strategy: strategy,
                        start_date: startDate,
                        end_date: endDate,
                    }),
                });
                
                const results = await response.json();
                
                if (results.success) {
                    displayBacktestResults(results);
                    updatePerformanceMetrics(results.performance_metrics);
                } else {
                    console.error('Backtest failed:', results.error);
                    alert('Backtest failed: ' + results.error);
                }
            } catch (error) {
                console.error('Error running backtest:', error);
                alert('Error running backtest');
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = 'Run Backtest';
                showLoading(false);
            }
        }
        
        function displayBacktestResults(results) {
            const resultsDiv = document.getElementById('backtestResults');
            
            if (results.summary_report) {
                // Display text summary if available
                resultsDiv.innerHTML = `<pre style="font-size: 12px; color: #e0e0e0;">${results.summary_report}</pre>`;
            } else {
                // Display metrics in formatted layout
                const metricsHtml = Object.entries(results.performance_metrics || {})
                    .map(([key, value]) => {
                        const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        const formattedValue = typeof value === 'number' ? 
                            (key.includes('pct') || key.includes('rate') ? `${value.toFixed(2)}%` : value.toFixed(2)) : 
                            value;
                        const valueClass = value > 0 ? 'metric-positive' : value < 0 ? 'metric-negative' : '';
                        
                        return `
                            <div class="result-metric">
                                <span class="metric-label">${formattedKey}</span>
                                <span class="metric-value ${valueClass}">${formattedValue}</span>
                            </div>
                        `;
                    }).join('');
                
                resultsDiv.innerHTML = metricsHtml;
            }
        }
        
        function updatePerformanceMetrics(metrics) {
            if (!metrics) return;
            
            // Update performance card
            document.getElementById('totalReturn').textContent = 
                metrics.total_return_pct ? `${metrics.total_return_pct.toFixed(2)}%` : '--';
            document.getElementById('totalReturn').className = 
                `metric-value ${metrics.total_return_pct > 0 ? 'metric-positive' : 'metric-negative'}`;
            
            document.getElementById('sharpeRatio').textContent = 
                metrics.sharpe_ratio ? metrics.sharpe_ratio.toFixed(2) : '--';
            
            document.getElementById('maxDrawdown').textContent = 
                metrics.max_drawdown_pct ? `${metrics.max_drawdown_pct.toFixed(2)}%` : '--';
            document.getElementById('maxDrawdown').className = 'metric-value metric-negative';
            
            document.getElementById('winRate').textContent = 
                metrics.win_rate_pct ? `${metrics.win_rate_pct.toFixed(1)}%` : '--';
            document.getElementById('winRate').className = 
                `metric-value ${metrics.win_rate_pct > 50 ? 'metric-positive' : 'metric-negative'}`;
            
            document.getElementById('profitFactor').textContent = 
                metrics.profit_factor ? metrics.profit_factor.toFixed(2) : '--';
            document.getElementById('profitFactor').className = 
                `metric-value ${metrics.profit_factor > 1 ? 'metric-positive' : 'metric-negative'}`;
        }
        
        async function updateCacheStats() {
            try {
                const response = await fetch(`/api/cache/stats?symbol=${currentSymbol}`);
                const stats = await response.json();
                
                if (stats.success) {
                    document.getElementById('cachedSymbols').textContent = stats.symbols || 0;
                    document.getElementById('totalRecords').textContent = 
                        stats.total_records ? stats.total_records.toLocaleString() : '0';
                    document.getElementById('cacheSize').textContent = 
                        stats.cache_size_mb ? `${stats.cache_size_mb.toFixed(1)} MB` : '0 MB';
                    document.getElementById('lastUpdate').textContent = 
                        stats.last_update ? new Date(stats.last_update).toLocaleTimeString() : 'Never';
                    
                    if (stats.earliest_data && stats.latest_data) {
                        const earliest = new Date(stats.earliest_data).toLocaleDateString();
                        const latest = new Date(stats.latest_data).toLocaleDateString();
                        document.getElementById('dataRange').textContent = `${earliest} - ${latest}`;
                    }
                }
            } catch (error) {
                console.error('Error updating cache stats:', error);
            }
        }
        
        function setDefaultDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 3); // 3 months back
            
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        }
        
        function startAutoRefresh() {
            if (autoRefreshInterval) return;
            
            autoRefreshInterval = setInterval(() => {
                if (isMarketOpen) {
                    loadChartData();
                }
                updateCacheStats();
            }, 30000); // Refresh every 30 seconds
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        function loadInitialData() {
            loadChartData();
            
            if (document.getElementById('autoRefresh').checked) {
                startAutoRefresh();
            }
        }
        
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        function updateLatestPrice(data) {
            // Update the last candle with real-time price if market is open
            if (candlestickSeries && data.price) {
                const lastCandle = {
                    time: Math.floor(new Date().getTime() / 1000),
                    close: data.price,
                };
                candlestickSeries.update(lastCandle);
            }
        }
    </script>
</body>
</html>